server:
  port: 9000
spring:
  application:
    name: oauth2-gateway
  sleuth:
    sampler:
      # 采样率：1.0 表示 100% 采样（生产环境建议降低）
      probability: 1.0
    web:
      # 跳过不需要追踪的路径
      skip-pattern: /actuator.*|/health.*
  zipkin:
    # Zipkin 服务器地址
    base-url: http://154.219.109.125:9411
    # 发送方式：web（HTTP）或 kafka/rabbitmq
    sender:
      type: web
    # 启用 Zipkin
    enabled: true
  thymeleaf:
    check-template-location: false
  cloud:
    nacos:
      discovery:
        server-addr: 154.219.109.125:8848
        namespace: public
        group: DEFAULT_GROUP
        # 开发环境允许启动失败容错
        fail-fast: false
    sentinel:
      enabled: true
      eager: true  # 启动时立即初始化 Sentinel
      transport:
        dashboard: localhost:8858        # Sentinel 控制台地址（本地）
        port: 8721                       # 与控制台通信的端口（Gateway 专用）
        heartbeat-interval-ms: 5000      # 心跳间隔 5 秒
      # 不配置 datasource，直接在 Sentinel 控制台管理规则
      filter:
        enabled: true
      # Gateway 专用配置
      scg:
        fallback:
          mode: response
          response-status: 429
          response-body: '{"code":429,"message":"请求过于频繁，请稍后再试"}'
      web-context-unify: false
    gateway:
      routes:
        # ========== 公开接口（不需要认证） ==========
        
        # OAuth2认证服务路由
        - id: auth-server
          uri: http://localhost:8080
          predicates:
            - Path=/api/v1/auth/**,/api/oauth/**,/oauth/**
          filters:
            - StripPrefix=0
            - AddRequestHeader=X-Gateway-Service, IM-Gateway
        
        # 用户服务路由
        - id: user-server
          uri: http://localhost:8082
          predicates:
            - Path=/api/v1/users/**,/api/v1/email/**,/api/v1/security/**
          filters:
            - StripPrefix=0
            - AddRequestHeader=X-Gateway-Service, IM-Gateway
        
        # 消息服务路由
        - id: message-server
          uri: http://localhost:8002
          predicates:
            - Path=/api/v1/chat/**
          filters:
            - StripPrefix=0
            - AddRequestHeader=X-Gateway-Service, IM-Gateway
        
        # 群组、好友、组织架构服务路由  
        - id: relationship-server
          uri: http://localhost:8003
          predicates:
            - Path=/api/v1/groups/**,/api/v1/friends/**,/api/v1/organization/**
          filters:
            - StripPrefix=0
            - AddRequestHeader=X-Gateway-Service, IM-Gateway

# CORS 配置已完全移至 CorsConfig.java 类中处理

# 服务间认证配置
# 必须与其他服务保持一致
service:
  auth:
    # 密钥必须至少32位
    secret: your_32_character_secret_key_here_12345

# 日志配置 - 显示 TraceId 和 SpanId
logging:
  pattern:
    level: '%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]'
  level:
    root: INFO
    com.example: INFO
    # Sleuth 日志级别
    org.springframework.cloud.sleuth: DEBUG
    # Sentinel 日志级别（调试用）
    com.alibaba.csp.sentinel: INFO
    com.alibaba.cloud.sentinel: DEBUG
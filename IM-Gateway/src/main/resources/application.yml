server:
  port: 9001
  # WebSocket连接配置
  netty:
    connection-timeout: 30s
    idle-timeout: 600s  # 10分钟空闲超时

spring:
  application:
    name: im-gateway
  main:
    web-application-type: reactive

  # 禁用静态资源服务（纯API网关，不提供前端）
  web:
    resources:
      add-mappings: false

  # Redis配置（用于限流）
  redis:
    host: localhost
    port: 6379

  # Default: dev profile
  cloud:
    nacos:
      discovery:
        enabled: true  # 默认启用Nacos
        server-addr: 154.219.109.125:8848
        namespace: public
    gateway:
      # IM专用WebSocket网关配置
      httpclient:
        websocket:
          max-frame-payload-length: 10485760  # 10MB
        connect-timeout: 10000
        response-timeout: 30s
      # 负载均衡配置
      loadbalancer:
        use404: true
      routes:
        # WebSocket路由 - 直连到消息服务
        - id: chat-service-websocket
          uri: lb:ws://IM-message-server  # 使用Nacos进行负载均衡 (WebSocket)
          predicates:
            - Path=/ws/**
          metadata:
            response-timeout: 600000  # WebSocket长连接超时10分钟
            connect-timeout: 10000
        
        # 公开聊天API路由
        - id: chat-service-public-api
          uri: lb://IM-message-server
          predicates:
            - Path=/v1/api/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"
        
        # 内部API路由 - 需要服务间认证
        - id: chat-service-internal-api
          uri: lb://IM-message-server
          predicates:
            - Path=/internal/**
          filters:
            - StripPrefix=0
        
        # 健康检查路由
        - id: chat-service-health
          uri: lb://IM-message-server
          predicates:
            - Path=/actuator/**
          filters:
            - StripPrefix=0
        
        # 网关自身健康检查
        - id: gateway-health
          uri: no://op
          predicates:
            - Path=/gateway/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20

# 服务间认证配置
service:
  auth:
    secret: "IM-message-server-secret-key-for-service-authentication-2025"

# 日志配置
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    reactor.netty: INFO
    org.example.imgateway: DEBUG
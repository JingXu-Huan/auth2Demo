# 🚀 数据库架构更新说明

## 📋 更新概览

基于完整的企业级协作平台架构设计，已对项目进行以下更新：

### 1. 数据库架构升级 ✅

创建了 8 个独立微服务数据库：
- `auth_db` - 用户认证数据库
- `im_db` - 即时通讯数据库  
- `relationship_db` - 好友关系数据库
- `file_db` - 文件存储数据库（CAS）
- `doc_db` - 文档协同数据库（CRDT）
- `org_db` - 组织权限数据库
- `event_db` - 事件消息队列数据库
- `search_db` - 搜索缓存数据库

### 2. 实体类更新 ✅

已更新以下实体类以匹配新表结构：

#### IM-relationship-server
- `FriendRequest.java` - 好友申请实体
- `FriendRelation.java` - 好友关系实体

#### IM-message-server  
- `Message.java` - 消息实体（读扩散模型）
- `MessageInbox.java` - 消息收件箱（写扩散模型）
- `Channel.java` - 频道/会话实体

#### IM-file-server
- `FileMetadata.java` - 文件元数据（CAS去重）
- `UserFile.java` - 用户文件关联

### 3. Mapper 接口更新 ✅

- `FriendRequestMapper.java` - 好友申请操作
- `FriendRelationMapper.java` - 好友关系操作
- `FileMetadataMapper.java` - 文件元数据操作
- `UserFileMapper.java` - 用户文件操作

### 4. 配置文件更新 ✅

#### 数据库连接配置
- IM-message-server → `im_db`
- IM-relationship-server → `relationship_db`  
- IM-file-server → `file_db`

#### MinIO 配置优化
- 配置路径调整为 `app.minio.*`
- 修复了 YAML 配置警告

## 🔧 如何使用

### 1. 初始化数据库

**Windows 系统：**
```batch
cd scripts
init-all-databases.bat
```

**Linux/Mac 系统：**
```bash
cd scripts
chmod +x init-all-databases.sh
./init-all-databases.sh
```

### 2. 启动服务

按以下顺序启动微服务：
1. Oauth2-auth-server（认证服务）
2. IM-message-server（消息服务）
3. IM-relationship-server（关系服务）
4. IM-file-server（文件服务）
5. Gateway（网关）

### 3. 验证数据库

连接 PostgreSQL 验证数据库创建：
```sql
\l  -- 列出所有数据库
\c im_db  -- 连接到 im_db
\dt  -- 列出所有表
```

## 🏗️ 核心特性

### 消息系统
- **混合投递模型**：小群写扩散，大群读扩散
- **分区策略**：按月 Range 分区，支持百亿级数据
- **BRIN 索引**：历史分区节省 95% 索引空间

### 文件系统  
- **CAS 去重**：基于 SHA-256 内容寻址
- **引用计数**：自动垃圾回收
- **秒传支持**：相同文件立即返回

### 权限系统
- **RBAC + ReBAC**：角色与关系双重控制
- **权限缓存**：提高查询性能
- **审计日志**：完整操作记录

## ⚠️ 注意事项

1. **数据库依赖**
   - PostgreSQL 14+ 
   - 启用 JSONB 支持
   - 安装 pg_partman 扩展（可选）

2. **配置警告说明**
   - `Unknown property` 警告：自定义配置属性，不影响功能
   - 特殊字符警告：标准日志配置键，可忽略

3. **性能优化建议**
   - IM 服务连接池：30-50 连接
   - 文件服务连接池：10-20 连接
   - 关系服务连接池：10-20 连接

## 📊 数据容量设计

| 服务 | 数据规模 | 分区策略 | 索引类型 |
|------|----------|----------|----------|
| 消息 | 100亿条 | 月度Range | BRIN+B-Tree |
| 文件 | 1000万个 | 无 | Hash(SHA-256) |
| 用户 | 1000万 | 无 | B-Tree |
| 关系 | 1亿条 | 无 | B-Tree |

## 🔄 下一步计划

- [ ] 更新 Service 层业务逻辑
- [ ] 实现消息分区自动管理
- [ ] 添加 Elasticsearch 集成
- [ ] 实现 Neo4j 图数据库同步
- [ ] 配置 Redis 缓存策略

## 📝 相关文档

- [架构蓝图](../项目架构/架构蓝图.md)
- [数据库设计文档](./README.md)
- [API 文档](../aaa-前端/API文档.md)

---

更新时间：2024-11-25
作者：System Architect

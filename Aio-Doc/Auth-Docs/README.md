# ğŸ” OAuth2 è®¤è¯ç³»ç»Ÿå¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®ç®€ä»‹

åŸºäº Spring Cloud çš„å¾®æœåŠ¡ OAuth2 è®¤è¯æˆæƒç³»ç»Ÿï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€é‚®ç®±éªŒè¯ã€ç¬¬ä¸‰æ–¹ç™»å½•ç­‰åŠŸèƒ½ã€‚

### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| Spring Boot | 2.7.18 | åŸºç¡€æ¡†æ¶ |
| Spring Cloud | 2021.0.8 | å¾®æœåŠ¡æ¡†æ¶ |
| Spring Security OAuth2 | 2.3.4 | è®¤è¯æˆæƒ |
| PostgreSQL | 42.7.1 | æ•°æ®åº“ |
| Redis | - | ç¼“å­˜/Session |
| RabbitMQ | - | æ¶ˆæ¯é˜Ÿåˆ— |
| Nacos | 2.2.0 | æœåŠ¡æ³¨å†Œå‘ç° |
| Sentinel | 1.8.6 | æµé‡æ§åˆ¶ |
| Zipkin | - | é“¾è·¯è¿½è¸ª |

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Gateway (9000)              â”‚
â”‚  - ç»Ÿä¸€å…¥å£                          â”‚
â”‚  - è·¯ç”±è½¬å‘                          â”‚
â”‚  - è®¤è¯è¿‡æ»¤                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAuth2-Auth  â”‚  â”‚ User-Server  â”‚  â”‚ Email-Server â”‚
â”‚   (8080)     â”‚  â”‚   (8082)     â”‚  â”‚   (8083)     â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ - Tokenç­¾å‘  â”‚  â”‚ - ç”¨æˆ·ç®¡ç†   â”‚  â”‚ - é‚®ä»¶å‘é€   â”‚
â”‚ - ç™»å½•è®¤è¯   â”‚  â”‚ - é‚®ç®±éªŒè¯   â”‚  â”‚ - éªŒè¯ç      â”‚
â”‚ - ç¬¬ä¸‰æ–¹ç™»å½• â”‚  â”‚ - å®‰å…¨éªŒè¯   â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL  â”‚    â”‚    Redis     â”‚
        â”‚    (5432)    â”‚    â”‚    (6379)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- JDK 1.8+
- Maven 3.6+
- PostgreSQL 12+
- Redis 5.0+
- RabbitMQ 3.8+

### æ•°æ®åº“é…ç½®

```yaml
# æ•°æ®åº“è¿æ¥ä¿¡æ¯
host: 101.42.157.163
port: 5432
database: aio
username: user
password: 202430904JINGxu
```

### åˆå§‹åŒ–æ•°æ®åº“

```bash
# æ‰§è¡Œå»ºè¡¨è¯­å¥
psql -h 101.42.157.163 -p 5432 -U user -d aio -f database/schema_postgresql.sql
```

### å¯åŠ¨æœåŠ¡

```bash
# 1. ç¼–è¯‘é¡¹ç›®
mvn clean install

# 2. æŒ‰é¡ºåºå¯åŠ¨æœåŠ¡
# å¯åŠ¨ Oauth2-auth-server (8080)
# å¯åŠ¨ User-server (8082)
# å¯åŠ¨ Email-server (8083)
# å¯åŠ¨ Gateway (9000)
```

### è®¿é—® Swagger æ–‡æ¡£

- Gateway: http://localhost:9000/doc.html
- OAuth2-Auth: http://localhost:8080/doc.html
- User-Server: http://localhost:8082/doc.html

---

## æ¶æ„è®¾è®¡

### æœåŠ¡åˆ’åˆ†

#### 1. Gateway (ç½‘å…³æœåŠ¡)
- **ç«¯å£**: 9000
- **èŒè´£**: 
  - ç»Ÿä¸€å…¥å£
  - è·¯ç”±è½¬å‘
  - è®¤è¯è¿‡æ»¤
  - è·¨åŸŸå¤„ç†
  - é™æµç†”æ–­

#### 2. Oauth2-auth-server (è®¤è¯æœåŠ¡)
- **ç«¯å£**: 8080
- **èŒè´£**:
  - OAuth2 Token ç­¾å‘
  - ç”¨æˆ·ç™»å½•è®¤è¯
  - ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆGiteeï¼‰
  - ç™»å½•å¤±è´¥é™åˆ¶
  - ç™»å½•æˆåŠŸå¤„ç†

#### 3. User-server (ç”¨æˆ·æœåŠ¡)
- **ç«¯å£**: 8082
- **èŒè´£**:
  - ç”¨æˆ·æ³¨å†Œ
  - ç”¨æˆ·ä¿¡æ¯ç®¡ç†
  - é‚®ç®±éªŒè¯
  - å¯†ç ä¿®æ”¹
  - ç™»å½•å®‰å…¨éªŒè¯

#### 4. Email-server (é‚®ä»¶æœåŠ¡)
- **ç«¯å£**: 8083
- **èŒè´£**:
  - é‚®ä»¶å‘é€
  - éªŒè¯ç ç”Ÿæˆ
  - æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹

### æ•°æ®åº“è®¾è®¡

è¯¦è§: [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./DATABASE_DESIGN.md)

### å®‰å…¨è®¾è®¡

è¯¦è§: [å®‰å…¨è®¾è®¡æ–‡æ¡£](./SECURITY_DESIGN.md)

---

## API æ–‡æ¡£

### å®Œæ•´ API åˆ—è¡¨

è¯¦è§å„æœåŠ¡çš„ Swagger æ–‡æ¡£æˆ–æŸ¥çœ‹:
- [ç”¨æˆ·æ³¨å†Œç™»å½• API](./API_USER_AUTH.md)
- [é‚®ç®±éªŒè¯ API](./API_EMAIL_VERIFICATION.md)
- [å®‰å…¨éªŒè¯ API](./API_SECURITY.md)
- [OAuth2 API](./API_OAUTH2.md)

### å¿«é€Ÿå‚è€ƒ

#### ç”¨æˆ·æ³¨å†Œ
```http
POST /api/users/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "Test@123"
}
```

#### é‚®ç®±éªŒè¯
```http
POST /api/email/verify-and-activate
Content-Type: application/json

{
  "email": "test@example.com",
  "code": "123456"
}
```

#### ç”¨æˆ·ç™»å½•
```http
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&username=test@example.com
&password=Test@123
&client_id=client
&client_secret=secret
```

---

## å®‰å…¨æœºåˆ¶

### 1. å¯†ç å®‰å…¨

#### å¼ºå¯†ç è¦æ±‚
- âœ… è‡³å°‘ 8 ä½å­—ç¬¦
- âœ… å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ (A-Z)
- âœ… å¿…é¡»åŒ…å«å°å†™å­—æ¯ (a-z)
- âœ… å¿…é¡»åŒ…å«æ•°å­— (0-9)
- âœ… å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦ (@$!%*?&)

#### å¯†ç åŠ å¯†
- ä½¿ç”¨ BCrypt åŠ å¯†å­˜å‚¨
- åŠ å¯†å¼ºåº¦: 10 rounds

### 2. ç™»å½•å®‰å…¨

#### ç™»å½•å¤±è´¥é™åˆ¶
- å¤±è´¥æ¬¡æ•°: 5 æ¬¡
- é”å®šæ—¶é—´: 15 åˆ†é’Ÿ
- å­˜å‚¨æ–¹å¼: Redis

#### é•¿æ—¶é—´æœªç™»å½•éªŒè¯
- é˜ˆå€¼: 30 å¤©
- éªŒè¯æ–¹å¼: é‚®ç®±éªŒè¯ç 
- æœ‰æ•ˆæœŸ: 15 åˆ†é’Ÿ

### 3. é‚®ç®±éªŒè¯

#### éªŒè¯ç è§„åˆ™
- é•¿åº¦: 6 ä½æ•°å­—
- æœ‰æ•ˆæœŸ: 5 åˆ†é’Ÿ
- å­˜å‚¨: Redis

### 4. Token å®‰å…¨

#### Access Token
- æœ‰æ•ˆæœŸ: 2 å°æ—¶
- å­˜å‚¨: Redis
- åˆ·æ–°: æ”¯æŒ

#### Refresh Token
- æœ‰æ•ˆæœŸ: 7 å¤©
- ä¸€æ¬¡æ€§ä½¿ç”¨

### 5. æœåŠ¡é—´è®¤è¯

- ä½¿ç”¨ JWT Token
- å¯†é’¥: 32 ä½
- è¿‡æœŸæ—¶é—´: 1 å°æ—¶

---

## éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/aio_dev
  redis:
    host: localhost
    port: 6379
  rabbitmq:
    host: localhost
    port: 5672
```

### ç”Ÿäº§ç¯å¢ƒ

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:postgresql://101.42.157.163:5432/aio
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  redis:
    host: prod-redis-host
    password: ${REDIS_PASSWORD}
  rabbitmq:
    host: prod-rabbitmq-host
    username: ${RABBITMQ_USER}
    password: ${RABBITMQ_PASSWORD}
```

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t oauth2-auth:latest ./Oauth2-auth-server
docker build -t user-server:latest ./User-server
docker build -t email-server:latest ./Email-server
docker build -t gateway:latest ./Gateway

# å¯åŠ¨æœåŠ¡
docker-compose up -d
```

### ç›‘æ§é…ç½®

- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000
- **Zipkin**: http://154.219.109.125:9411
- **Sentinel**: http://localhost:8858

---

## å¸¸è§é—®é¢˜

### Q1: ç™»å½•å¤±è´¥æç¤º"é‚®ç®±æœªéªŒè¯"ï¼Ÿ

**A**: ç”¨æˆ·æ³¨å†Œåå¿…é¡»å…ˆéªŒè¯é‚®ç®±æ‰èƒ½ç™»å½•ã€‚

è§£å†³æ­¥éª¤:
1. è°ƒç”¨ `/api/email/send-code` å‘é€éªŒè¯ç 
2. è°ƒç”¨ `/api/email/verify-and-activate` éªŒè¯é‚®ç®±

### Q2: è´¦æˆ·è¢«é”å®šæ€ä¹ˆåŠï¼Ÿ

**A**: ç™»å½•å¤±è´¥ 5 æ¬¡åä¼šè¢«é”å®š 15 åˆ†é’Ÿã€‚

è§£å†³æ–¹æ¡ˆ:
- ç­‰å¾… 15 åˆ†é’Ÿè‡ªåŠ¨è§£é”
- æˆ–è”ç³»ç®¡ç†å‘˜æ‰‹åŠ¨è§£é”

### Q3: é•¿æ—¶é—´æœªç™»å½•éœ€è¦éªŒè¯ï¼Ÿ

**A**: è¶…è¿‡ 30 å¤©æœªç™»å½•éœ€è¦é‚®ç®±éªŒè¯ã€‚

è§£å†³æ­¥éª¤:
1. è°ƒç”¨ `/api/security/check` æ£€æŸ¥çŠ¶æ€
2. è°ƒç”¨ `/api/security/send-code` å‘é€éªŒè¯ç 
3. è°ƒç”¨ `/api/security/verify-code` éªŒè¯é€šè¿‡
4. 15 åˆ†é’Ÿå†…å®Œæˆç™»å½•

### Q4: å¯†ç å¼ºåº¦ä¸ç¬¦åˆè¦æ±‚ï¼Ÿ

**A**: å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œè‡³å°‘ 8 ä½ã€‚

åˆæ ¼ç¤ºä¾‹:
- `Admin@123`
- `Test@2024`
- `MyP@ssw0rd`

### Q5: Token è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

**A**: ä½¿ç”¨ Refresh Token åˆ·æ–°ã€‚

```http
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token=YOUR_REFRESH_TOKEN
&client_id=client
&client_secret=secret
```

### Q6: å¦‚ä½•é›†æˆç¬¬ä¸‰æ–¹ç™»å½•ï¼Ÿ

**A**: ç›®å‰æ”¯æŒ Gitee ç™»å½•ã€‚

é›†æˆæ­¥éª¤:
1. åœ¨ Gitee åˆ›å»º OAuth åº”ç”¨
2. é…ç½® `application.yml`:
   ```yaml
   gitee:
     oauth:
       client-id: YOUR_CLIENT_ID
       client-secret: YOUR_CLIENT_SECRET
       redirect-uri: http://localhost:8080/oauth/gitee/callback
   ```
3. å¼•å¯¼ç”¨æˆ·è®¿é—® `/oauth/gitee/authorize`

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./DATABASE_DESIGN.md)
- [å®‰å…¨è®¾è®¡æ–‡æ¡£](./SECURITY_DESIGN.md)
- [API æ¥å£æ–‡æ¡£](./API_REFERENCE.md)
- [éƒ¨ç½²è¿ç»´æ–‡æ¡£](./DEPLOYMENT.md)
- [å¼€å‘è§„èŒƒ](./DEVELOPMENT_GUIDE.md)

---

## è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**: G:\Projects\Java_Study\test\01\auth2Demo
- **æ–‡æ¡£æ›´æ–°**: 2025-11-10
- **ç‰ˆæœ¬**: 2.0

---

## æ›´æ–°æ—¥å¿—

### v2.0 (2025-11-10)
- âœ… æ•°æ®åº“ä» MySQL è¿ç§»åˆ° PostgreSQL
- âœ… æ·»åŠ å¼ºå¯†ç éªŒè¯
- âœ… å®Œå–„ç™»å½•å®‰å…¨æœºåˆ¶
- âœ… æ·»åŠ é•¿æ—¶é—´æœªç™»å½•éªŒè¯
- âœ… ä¼˜åŒ– API æ¥å£
- âœ… å®Œå–„æ–‡æ¡£

### v1.0 (2025-11-06)
- âœ… åŸºç¡€è®¤è¯åŠŸèƒ½
- âœ… ç”¨æˆ·æ³¨å†Œç™»å½•
- âœ… é‚®ç®±éªŒè¯
- âœ… OAuth2 é›†æˆ

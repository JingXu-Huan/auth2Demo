# ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å…¨é¢æ¢³ç†

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-11-10

---

## ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨è¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gateway (9000)                            â”‚
â”‚  - è·¯ç”±è½¬å‘                                                  â”‚
â”‚  - Sentinel é™æµï¼ˆNacos åŠ¨æ€ç®¡ç†ï¼‰                           â”‚
â”‚  - é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Oauth2-auth  â”‚ â”‚ User-server  â”‚ â”‚ Email-server â”‚
â”‚   (8080)     â”‚ â”‚   (8082)     â”‚ â”‚   (8083)     â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ - è®¤è¯æˆæƒ   â”‚ â”‚ - ç”¨æˆ·ç®¡ç†   â”‚ â”‚ - é‚®ä»¶å‘é€   â”‚
â”‚ - Token ç®¡ç† â”‚ â”‚ - ç™»å½•æ—¥å¿—   â”‚ â”‚ - éªŒè¯ç      â”‚
â”‚ - Feign è°ƒç”¨ â”‚ â”‚ - å¯†ç ç®¡ç†   â”‚ â”‚              â”‚
â”‚ - Sentinel   â”‚ â”‚ - Sentinel   â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚
        â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL  â”‚ â”‚    Redis     â”‚
â”‚   (5432)     â”‚ â”‚   (6379)     â”‚
â”‚              â”‚ â”‚              â”‚
â”‚ - ç”¨æˆ·æ•°æ®   â”‚ â”‚ - Token å­˜å‚¨ â”‚
â”‚ - ç™»å½•æ—¥å¿—   â”‚ â”‚ - éªŒè¯ç      â”‚
â”‚ - å¯†ç å†å²   â”‚ â”‚ - ç™»å½•é™åˆ¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€è®¾æ–½æœåŠ¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nacos        â”‚ Sentinel     â”‚ Zipkin       â”‚ RabbitMQ       â”‚
â”‚ (8848)       â”‚ (8858)       â”‚ (9411)       â”‚ (5672)         â”‚
â”‚              â”‚              â”‚              â”‚                â”‚
â”‚ - æœåŠ¡æ³¨å†Œ   â”‚ - æµæ§ç›‘æ§   â”‚ - é“¾è·¯è¿½è¸ª   â”‚ - æ¶ˆæ¯é˜Ÿåˆ—     â”‚
â”‚ - é…ç½®ç®¡ç†   â”‚ - è§„åˆ™ç®¡ç†   â”‚ - æ€§èƒ½åˆ†æ   â”‚ - å¼‚æ­¥é€šçŸ¥     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒæœåŠ¡è¯¦è§£

### 1. Gateway (ç½‘å…³æœåŠ¡)

**ç«¯å£**: 9000  
**èŒè´£**: ç»Ÿä¸€å…¥å£ã€è·¯ç”±è½¬å‘ã€é™æµä¿æŠ¤

#### é…ç½®ç±»

| é…ç½®ç±» | èŒè´£ | é‡è¦æ€§ |
|--------|------|--------|
| `GatewaySentinelConfig` | Sentinel é™æµé…ç½® | â­â­â­ |
| `CorsConfig` | è·¨åŸŸé…ç½® | â­â­ |

#### æ ¸å¿ƒåŠŸèƒ½

```yaml
# è·¯ç”±é…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: auth-server          # è®¤è¯æœåŠ¡
        - id: user-register        # ç”¨æˆ·æ³¨å†Œ
        - id: user-confirm         # é‚®ç®±éªŒè¯
        - id: security-verification # å®‰å…¨éªŒè¯
        - id: user-server          # ç”¨æˆ·æœåŠ¡ï¼ˆéœ€è®¤è¯ï¼‰
```

#### é™æµè§„åˆ™ï¼ˆNacos ç®¡ç†ï¼‰

- `auth-server`: 50 QPS
- `user-register`: 10 QPS
- `user-confirm`: 20 QPS
- `security-verification`: 30 QPS
- `user-server`: 100 QPS

---

### 2. Oauth2-auth-server (è®¤è¯æˆæƒæœåŠ¡)

**ç«¯å£**: 8080  
**èŒè´£**: OAuth2 è®¤è¯ã€Token ç®¡ç†ã€ç”¨æˆ·ç™»å½•

#### ğŸ”‘ æ ¸å¿ƒé…ç½®ç±»ï¼ˆ9ä¸ªï¼‰

##### A. OAuth2 æ ¸å¿ƒé…ç½®ï¼ˆ3ä¸ªï¼‰

| é…ç½®ç±» | èŒè´£ | å…³é”®ç‚¹ |
|--------|------|--------|
| **`AuthorizationServerConfig`** | OAuth2 æˆæƒæœåŠ¡å™¨é…ç½® | â­â­â­â­â­ |
| **`WebSecurityConfig`** | Spring Security å®‰å…¨é…ç½® | â­â­â­â­â­ |
| **`RedisTokenStoreConfig`** | Token å­˜å‚¨é…ç½® | â­â­â­â­ |

**è¯¦ç»†è¯´æ˜**:

```java
// 1. AuthorizationServerConfig - OAuth2 æ ¸å¿ƒ
@Configuration
@EnableAuthorizationServer  // å¯ç”¨æˆæƒæœåŠ¡å™¨
public class AuthorizationServerConfig {
    
    // é…ç½®å®¢æˆ·ç«¯ä¿¡æ¯
    public void configure(ClientDetailsServiceConfigurer clients) {
        clients.inMemory()
            .withClient("client")
            .secret("secret")
            .authorizedGrantTypes("password", "refresh_token")
            .accessTokenValiditySeconds(7200);  // 2å°æ—¶
    }
    
    // é…ç½®ç«¯ç‚¹
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {
        endpoints
            .tokenStore(tokenStore)           // Token å­˜å‚¨
            .authenticationManager(authenticationManager)  // è®¤è¯ç®¡ç†å™¨
            .userDetailsService(userDetailsService);       // ç”¨æˆ·æœåŠ¡
    }
}

// 2. WebSecurityConfig - å®‰å…¨æ ¸å¿ƒ
@Configuration
@EnableWebSecurity
public class WebSecurityConfig {
    
    // é…ç½®è®¤è¯ç®¡ç†å™¨
    @Bean
    public AuthenticationManager authenticationManager() {
        // ç”¨äº OAuth2 å¯†ç æ¨¡å¼
    }
    
    // é…ç½® HTTP å®‰å…¨
    protected void configure(HttpSecurity http) {
        http
            .authorizeRequests()
            .antMatchers("/oauth/**").permitAll()  // å…¬å¼€æ¥å£
            .anyRequest().authenticated();          // å…¶ä»–éœ€è®¤è¯
    }
}

// 3. RedisTokenStoreConfig - Token å­˜å‚¨
@Configuration
public class RedisTokenStoreConfig {
    
    @Bean
    public TokenStore tokenStore(RedisConnectionFactory factory) {
        return new RedisTokenStore(factory);  // Token å­˜å‚¨åœ¨ Redis
    }
}
```

##### B. å¢å¼ºåŠŸèƒ½é…ç½®ï¼ˆ2ä¸ªï¼‰

| é…ç½®ç±» | èŒè´£ | è¯´æ˜ |
|--------|------|------|
| **`CustomTokenEnhancer`** | Token å¢å¼ºå™¨ | æ·»åŠ è‡ªå®šä¹‰ä¿¡æ¯åˆ° Token |
| **`GiteeProperties`** | Gitee OAuth é…ç½® | ç¬¬ä¸‰æ–¹ç™»å½•é…ç½® |

##### C. å¾®æœåŠ¡é…ç½®ï¼ˆ2ä¸ªï¼‰

| é…ç½®ç±» | èŒè´£ | è¯´æ˜ |
|--------|------|------|
| **`SentinelConfig`** | Sentinel æµæ§é…ç½® | Feign è°ƒç”¨ç†”æ–­é™çº§ |
| **`FeignSentinelConfig`** | Feign Sentinel é…ç½® | å¯ç”¨ Feign ç†”æ–­ |

##### D. è¾…åŠ©é…ç½®ï¼ˆ2ä¸ªï¼‰

| é…ç½®ç±» | èŒè´£ | è¯´æ˜ |
|--------|------|------|
| **`ServiceAuthInterceptor`** | æœåŠ¡é—´è®¤è¯æ‹¦æˆªå™¨ | å†…éƒ¨æœåŠ¡è°ƒç”¨è®¤è¯ |
| **`SwaggerConfig`** | API æ–‡æ¡£é…ç½® | Swagger UI |

---

#### ğŸ¯ é…ç½®ç±»å…³ç³»å›¾

```
OAuth2 è®¤è¯æµç¨‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSecurityConfig                  â”‚  â† å®‰å…¨å…¥å£
â”‚  - é…ç½®ç™»å½•ç«¯ç‚¹                     â”‚
â”‚  - é…ç½®è®¤è¯ç®¡ç†å™¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthorizationServerConfig          â”‚  â† OAuth2 æ ¸å¿ƒ
â”‚  - å®¢æˆ·ç«¯é…ç½® (client/secret)       â”‚
â”‚  - Token æœ‰æ•ˆæœŸ (2å°æ—¶)             â”‚
â”‚  - æˆæƒæ¨¡å¼ (password)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
       â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RedisToken  â”‚  â”‚ CustomToken     â”‚
â”‚ StoreConfig â”‚  â”‚ Enhancer        â”‚
â”‚             â”‚  â”‚                 â”‚
â”‚ Tokenå­˜å‚¨   â”‚  â”‚ Tokenå¢å¼º       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡è°ƒç”¨ä¿æŠ¤
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SentinelConfig                     â”‚  â† æµæ§é…ç½®
â”‚  - Feign è°ƒç”¨é™æµ                   â”‚
â”‚  - ç†”æ–­é™çº§è§„åˆ™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FeignSentinelConfig                â”‚  â† Feign ç†”æ–­
â”‚  - å¯ç”¨ Sentinel                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. User-server (ç”¨æˆ·æœåŠ¡)

**ç«¯å£**: 8082  
**èŒè´£**: ç”¨æˆ·ç®¡ç†ã€ç™»å½•å®‰å…¨ã€æ•°æ®å­˜å‚¨

#### é…ç½®ç±»

| é…ç½®ç±» | èŒè´£ |
|--------|------|
| `MyBatisPlusConfig` | MyBatis-Plus é…ç½® |
| `PasswordConfig` | å¯†ç åŠ å¯†é…ç½® |
| `AsyncConfig` | å¼‚æ­¥ä»»åŠ¡é…ç½® |

#### æ ¸å¿ƒåŠŸèƒ½

- âœ… ç”¨æˆ·æ³¨å†Œï¼ˆç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥ï¼‰
- âœ… é‚®ç®±éªŒè¯
- âœ… å¯†ç å¼ºåº¦éªŒè¯
- âœ… ç™»å½•å¤±è´¥é™åˆ¶ï¼ˆRedisï¼‰
- âœ… å¯†ç å†å²æ£€æŸ¥
- âœ… Sentinel æµæ§

---

### 4. Email-server (é‚®ä»¶æœåŠ¡)

**ç«¯å£**: 8083  
**èŒè´£**: é‚®ä»¶å‘é€ã€éªŒè¯ç ç®¡ç†

#### æ ¸å¿ƒåŠŸèƒ½

- âœ… æ¬¢è¿é‚®ä»¶
- âœ… éªŒè¯ç é‚®ä»¶
- âœ… å¯†ç é‡ç½®é‚®ä»¶
- âœ… RabbitMQ å¼‚æ­¥å‘é€

---

## ğŸ” OAuth2 è®¤è¯æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
1. ç”¨æˆ·ç™»å½•è¯·æ±‚
   â†“
   POST /oauth/token
   {
     grant_type: "password",
     username: "user@example.com",
     password: "password",
     client_id: "client",
     client_secret: "secret"
   }
   â†“
2. Gateway è·¯ç”±è½¬å‘
   â†“
   Gateway (9000) â†’ Oauth2-auth-server (8080)
   â†“
3. WebSecurityConfig å®‰å…¨æ£€æŸ¥
   â†“
   - æ£€æŸ¥å®¢æˆ·ç«¯è®¤è¯ï¼ˆclient/secretï¼‰
   - æ£€æŸ¥ç”¨æˆ·è®¤è¯ï¼ˆusername/passwordï¼‰
   â†“
4. UserDetailsServiceImpl åŠ è½½ç”¨æˆ·
   â†“
   - Feign è°ƒç”¨ User-server
   - è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆé‚®ç®±ã€å¯†ç ã€è§’è‰²ï¼‰
   â†“
5. LoginAttemptFilter ç™»å½•é™åˆ¶æ£€æŸ¥
   â†“
   - æ£€æŸ¥ Redis ä¸­çš„å¤±è´¥æ¬¡æ•°
   - è¶…è¿‡ 5 æ¬¡åˆ™é”å®š 15 åˆ†é’Ÿ
   â†“
6. AuthenticationManager è®¤è¯
   â†“
   - éªŒè¯å¯†ç ï¼ˆBCryptï¼‰
   - éªŒè¯é‚®ç®±æ˜¯å¦å·²éªŒè¯
   â†“
7. è®¤è¯æˆåŠŸ/å¤±è´¥å¤„ç†
   â†“
   æˆåŠŸ: LoginSuccessHandler
   - æ¸…é™¤å¤±è´¥è®°å½•
   - æ›´æ–°æœ€åç™»å½•æ—¶é—´
   - è®°å½•ç»“æ„åŒ–æ—¥å¿—ï¼ˆELKï¼‰
   â†“
   å¤±è´¥: LoginFailureHandler
   - å¢åŠ å¤±è´¥æ¬¡æ•°
   - è®°å½•å¤±è´¥æ—¥å¿—ï¼ˆELKï¼‰
   - è¿”å›å‰©ä½™å°è¯•æ¬¡æ•°
   â†“
8. Token ç”Ÿæˆ
   â†“
   - AuthorizationServerConfig ç”Ÿæˆ Token
   - CustomTokenEnhancer å¢å¼º Token
   - RedisTokenStore å­˜å‚¨åˆ° Redis
   â†“
9. è¿”å› Token
   â†“
   {
     "access_token": "xxx",
     "token_type": "bearer",
     "refresh_token": "yyy",
     "expires_in": 7200,
     "scope": "read write"
   }
```

---

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

### 1. è®¤è¯å±‚é¢

| æœºåˆ¶ | å®ç°ä½ç½® | è¯´æ˜ |
|------|---------|------|
| **OAuth2 å¯†ç æ¨¡å¼** | AuthorizationServerConfig | æ ‡å‡† OAuth2 è®¤è¯ |
| **å®¢æˆ·ç«¯è®¤è¯** | WebSecurityConfig | client_id/client_secret |
| **ç”¨æˆ·è®¤è¯** | UserDetailsServiceImpl | é‚®ç®±/å¯†ç éªŒè¯ |
| **é‚®ç®±éªŒè¯** | UserDetailsServiceImpl | å¿…é¡»éªŒè¯é‚®ç®±æ‰èƒ½ç™»å½• |

### 2. é˜²æŠ¤å±‚é¢

| æœºåˆ¶ | å®ç°ä½ç½® | è¯´æ˜ |
|------|---------|------|
| **ç™»å½•å¤±è´¥é™åˆ¶** | LoginAttemptService | 5æ¬¡å¤±è´¥é”å®š15åˆ†é’Ÿ |
| **å¯†ç å¼ºåº¦éªŒè¯** | PasswordValidator | 8ä½+å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ |
| **ç”¨æˆ·åå”¯ä¸€æ€§** | UserController | æ³¨å†Œæ—¶æ£€æŸ¥ |
| **é‚®ç®±å”¯ä¸€æ€§** | UserController | æ³¨å†Œæ—¶æ£€æŸ¥ |
| **å¯†ç å†å²æ£€æŸ¥** | PasswordHistoryMapper | é˜²æ­¢é‡å¤ä½¿ç”¨æ—§å¯†ç  |

### 3. æµæ§å±‚é¢

| å±‚çº§ | å®ç°ä½ç½® | é™æµè§„åˆ™ |
|------|---------|----------|
| **Gateway** | GatewaySentinelConfig | æŒ‰è·¯ç”±é™æµï¼ˆSentinelæ§åˆ¶å°ï¼‰ |
| **Oauth2-auth** | SentinelConfig | Feignè°ƒç”¨é™æµ+ç†”æ–­ï¼ˆSentinelæ§åˆ¶å°ï¼‰ |
| **User-server** | application.yml | Sentinelæ§åˆ¶å°åŠ¨æ€è§„åˆ™ |

### 4. Token å®‰å…¨

| æœºåˆ¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **Token æœ‰æ•ˆæœŸ** | 2å°æ—¶ | ç¼©çŸ­æœ‰æ•ˆæœŸæé«˜å®‰å…¨æ€§ |
| **Refresh Token** | 7å¤© | æ”¯æŒåˆ·æ–° |
| **Redis å­˜å‚¨** | RedisTokenStore | æ”¯æŒæ’¤é”€ |

---

## ğŸ“Š æ•°æ®æµå‘

### ç”¨æˆ·æ³¨å†Œæµç¨‹

```
ç”¨æˆ·æäº¤æ³¨å†Œ
   â†“
Gateway (9000)
   â†“
User-server (8082)
   â†“
1. æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§
2. æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
3. éªŒè¯å¯†ç å¼ºåº¦
4. åˆ›å»ºç”¨æˆ·ï¼ˆPostgreSQLï¼‰
5. åˆ›å»ºç”¨æˆ·å‡­è¯ï¼ˆåŠ å¯†å¯†ç ï¼‰
   â†“
RabbitMQ å¼‚æ­¥æ¶ˆæ¯
   â†“
Email-server (8083)
   â†“
å‘é€éªŒè¯é‚®ä»¶
```

### ç™»å½•æµç¨‹

```
ç”¨æˆ·æäº¤ç™»å½•
   â†“
Gateway (9000)
   â†“
Oauth2-auth-server (8080)
   â†“
1. å®¢æˆ·ç«¯è®¤è¯
2. ç™»å½•é™åˆ¶æ£€æŸ¥ï¼ˆRedisï¼‰
3. Feign è°ƒç”¨ User-server
4. è·å–ç”¨æˆ·ä¿¡æ¯
5. å¯†ç éªŒè¯
6. ç”Ÿæˆ Tokenï¼ˆRedisï¼‰
7. è®°å½•æ—¥å¿—ï¼ˆELKï¼‰
   â†“
è¿”å› Token
```

---

## ğŸ”§ æŠ€æœ¯æ ˆæ€»è§ˆ

### æ ¸å¿ƒæ¡†æ¶

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Spring Boot | 2.7.x | åŸºç¡€æ¡†æ¶ |
| Spring Cloud | 2021.x | å¾®æœåŠ¡æ¡†æ¶ |
| Spring Security OAuth2 | 2.x | è®¤è¯æˆæƒ |
| Spring Cloud Gateway | 3.x | API ç½‘å…³ |

### æ•°æ®å­˜å‚¨

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| PostgreSQL | ç”¨æˆ·æ•°æ®ã€ç™»å½•æ—¥å¿— |
| Redis | Tokenå­˜å‚¨ã€éªŒè¯ç ã€ç™»å½•é™åˆ¶ |
| MyBatis-Plus | ORM æ¡†æ¶ |

### å¾®æœåŠ¡ç»„ä»¶

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| Nacos | æœåŠ¡æ³¨å†Œã€é…ç½®ç®¡ç† |
| Sentinel | æµæ§ã€ç†”æ–­ã€é™çº§ |
| Feign | æœåŠ¡é—´è°ƒç”¨ |
| Sleuth + Zipkin | é“¾è·¯è¿½è¸ª |
| RabbitMQ | æ¶ˆæ¯é˜Ÿåˆ— |

### ç›‘æ§è¿ç»´

| å·¥å…· | ç”¨é€” |
|------|------|
| Sentinel Dashboard | æµæ§ç›‘æ§ |
| Zipkin UI | é“¾è·¯è¿½è¸ªå¯è§†åŒ– |
| Nacos Console | é…ç½®ç®¡ç† |
| ELK | æ—¥å¿—æ”¶é›†åˆ†æ |

---

## ğŸ“ é…ç½®æ–‡ä»¶æ¸…å•

### Oauth2-auth-server

```yaml
application.yml:
  - ç«¯å£: 8080
  - Nacos æ³¨å†Œ
  - Redis é…ç½®
  - Sentinel é…ç½®
  - Sleuth + Zipkin
  - OAuth2 å®¢æˆ·ç«¯ä¿¡æ¯
```

### User-server

```yaml
application.yml:
  - ç«¯å£: 8082
  - PostgreSQL é…ç½®
  - Redis é…ç½®
  - Sentinel é…ç½®
  - RabbitMQ é…ç½®
```

### Gateway

```yaml
application.yml:
  - ç«¯å£: 9000
  - è·¯ç”±é…ç½®
  - Sentinel é…ç½®ï¼ˆNacosåŠ¨æ€ï¼‰
  - Sleuth + Zipkin
```

---

## âœ… ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥

### æ ¸å¿ƒåŠŸèƒ½

- âœ… OAuth2 è®¤è¯ï¼ˆå¯†ç æ¨¡å¼ï¼‰
- âœ… Token ç®¡ç†ï¼ˆRediså­˜å‚¨ï¼‰
- âœ… ç”¨æˆ·æ³¨å†Œï¼ˆé‚®ç®±éªŒè¯ï¼‰
- âœ… ç™»å½•å®‰å…¨ï¼ˆå¤±è´¥é™åˆ¶ï¼‰
- âœ… å¯†ç å®‰å…¨ï¼ˆå¼ºåº¦éªŒè¯ã€å†å²æ£€æŸ¥ï¼‰
- âœ… æœåŠ¡é—´è°ƒç”¨ï¼ˆFeignï¼‰
- âœ… æµæ§ä¿æŠ¤ï¼ˆSentinelï¼‰
- âœ… é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰
- âœ… æ—¥å¿—æ”¶é›†ï¼ˆELKï¼‰

### å®‰å…¨æ”¹è¿›

- âœ… Token æœ‰æ•ˆæœŸç¼©çŸ­ï¼ˆ2å°æ—¶ï¼‰
- âœ… ç™»å½•æ—¥å¿—ï¼ˆELKæ”¶é›†ï¼‰
- âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥
- âœ… å¯†ç å†å²æ£€æŸ¥
- âœ… é‚®ç®±éªŒè¯å¼ºåˆ¶

### å¾®æœåŠ¡ç»„ä»¶

- âœ… æœåŠ¡æ³¨å†Œï¼ˆNacosï¼‰
- âœ… é…ç½®ç®¡ç†ï¼ˆNacosï¼‰
- âœ… æµæ§é™çº§ï¼ˆSentinelï¼‰
- âœ… é“¾è·¯è¿½è¸ªï¼ˆZipkinï¼‰
- âœ… æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQï¼‰

---

## ğŸ¯ æ ¸å¿ƒé…ç½®ç±»é€ŸæŸ¥

### å¿…é¡»ç†è§£çš„ 5 ä¸ªé…ç½®ç±»

1. **`AuthorizationServerConfig`** - OAuth2 æˆæƒæœåŠ¡å™¨
   - é…ç½®å®¢æˆ·ç«¯
   - é…ç½® Token
   - é…ç½®ç«¯ç‚¹

2. **`WebSecurityConfig`** - Spring Security
   - é…ç½®è®¤è¯ç®¡ç†å™¨
   - é…ç½® HTTP å®‰å…¨
   - é…ç½®ç™»å½•ç«¯ç‚¹

3. **`RedisTokenStoreConfig`** - Token å­˜å‚¨
   - Token å­˜å‚¨åœ¨ Redis
   - æ”¯æŒ Token æ’¤é”€

4. **`UserDetailsServiceImpl`** - ç”¨æˆ·åŠ è½½
   - é€šè¿‡ Feign è°ƒç”¨ User-server
   - åŠ è½½ç”¨æˆ·è¯¦æƒ…
   - éªŒè¯é‚®ç®±çŠ¶æ€

5. **`LoginAttemptService`** - ç™»å½•é™åˆ¶
   - Redis è®°å½•å¤±è´¥æ¬¡æ•°
   - 5æ¬¡å¤±è´¥é”å®š15åˆ†é’Ÿ

---

## ğŸ“– æ¨èé˜…è¯»é¡ºåº

### æ–°æ‰‹å…¥é—¨

1. å…ˆçœ‹ **æ¶æ„å›¾**ï¼Œç†è§£æ•´ä½“ç»“æ„
2. ç†è§£ **OAuth2 è®¤è¯æµç¨‹**
3. å­¦ä¹  **5 ä¸ªæ ¸å¿ƒé…ç½®ç±»**
4. äº†è§£ **å®‰å…¨æœºåˆ¶**

### æ·±å…¥å­¦ä¹ 

1. ç ”ç©¶ **Sentinel æµæ§**
2. å­¦ä¹  **Feign æœåŠ¡è°ƒç”¨**
3. æŒæ¡ **é“¾è·¯è¿½è¸ª**
4. ä¼˜åŒ– **æ€§èƒ½å’Œå®‰å…¨**

---

**ç³»ç»Ÿæ¶æ„æ¸…æ™°å®Œæ•´ï¼** ğŸ‰

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå®‰å…¨æœºåˆ¶å·²åˆ°ä½ï¼Œå¾®æœåŠ¡ç»„ä»¶å·²é…ç½®ï¼
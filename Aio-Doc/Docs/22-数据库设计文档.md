# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ðŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0.0
- **æœ€åŽæ›´æ–°**: 2025-11-11
- **æ•°æ®åº“**: PostgreSQL 13+
- **ç»´æŠ¤äºº**: æ•°æ®åº“å›¢é˜Ÿ

---

## ðŸ—„ï¸ æ•°æ®åº“æ¦‚è¿°

### æ•°æ®åº“åˆ—è¡¨

| æ•°æ®åº“å | è¯´æ˜Ž | æœåŠ¡ |
|---------|------|------|
| **aio_user** | ç”¨æˆ·æ•°æ®åº“ | user-service |
| **aio_message** | æ¶ˆæ¯æ•°æ®åº“ | message-service |
| **aio_group** | ç¾¤ç»„æ•°æ®åº“ | group-service |
| **aio_file** | æ–‡ä»¶æ•°æ®åº“ | file-service |
| **aio_calendar** | æ—¥ç¨‹æ•°æ®åº“ | calendar-service |
| **aio_task** | ä»»åŠ¡æ•°æ®åº“ | task-service |
| **aio_meeting** | ä¼šè®®æ•°æ®åº“ | meeting-service |
| **aio_approval** | å®¡æ‰¹æ•°æ®åº“ | approval-service |
| **aio_organization** | ç»„ç»‡æž¶æž„æ•°æ®åº“ | organization-service |

---

## ðŸ“Š ç”¨æˆ·æœåŠ¡æ•°æ®åº“ (aio_user)

### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰

```sql
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(500),
    signature VARCHAR(200),
    gender VARCHAR(10) CHECK (gender IN ('MALE', 'FEMALE', 'UNKNOWN')),
    birthday DATE,
    location VARCHAR(100),
    status VARCHAR(20) DEFAULT 'OFFLINE' CHECK (status IN ('ONLINE', 'OFFLINE', 'BUSY', 'AWAY')),
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨';
COMMENT ON COLUMN users.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN users.email_verified IS 'é‚®ç®±æ˜¯å¦å·²éªŒè¯';
```

### 2. user_friendsï¼ˆå¥½å‹å…³ç³»è¡¨ï¼‰

```sql
CREATE TABLE user_friends (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    friend_id BIGINT NOT NULL REFERENCES users(user_id),
    remark VARCHAR(50),
    source VARCHAR(20) CHECK (source IN ('SEARCH', 'QR_CODE', 'PHONE', 'GROUP')),
    status VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED', 'BLOCKED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id)
);

CREATE INDEX idx_friends_user_id ON user_friends(user_id);
CREATE INDEX idx_friends_friend_id ON user_friends(friend_id);
CREATE INDEX idx_friends_status ON user_friends(status);
```

### 3. password_historyï¼ˆå¯†ç åŽ†å²è¡¨ï¼‰

```sql
CREATE TABLE password_history (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_password_history_user_id ON password_history(user_id);
CREATE INDEX idx_password_history_created_at ON password_history(created_at);
```

### 4. login_logsï¼ˆç™»å½•æ—¥å¿—è¡¨ï¼‰

```sql
CREATE TABLE login_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    email VARCHAR(100),
    ip_address VARCHAR(50),
    user_agent TEXT,
    device_type VARCHAR(20),
    device_id VARCHAR(100),
    success BOOLEAN,
    failure_reason VARCHAR(200),
    login_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_login_logs_user_id ON login_logs(user_id);
CREATE INDEX idx_login_logs_ip ON login_logs(ip_address);
CREATE INDEX idx_login_logs_login_at ON login_logs(login_at);
```

---

## ðŸ’¬ æ¶ˆæ¯æœåŠ¡æ•°æ®åº“ (aio_message)

### 1. messagesï¼ˆæ¶ˆæ¯è¡¨ï¼‰

```sql
CREATE TABLE messages (
    message_id VARCHAR(50) PRIMARY KEY,
    sender_id BIGINT NOT NULL,
    receiver_id BIGINT,
    group_id VARCHAR(50),
    message_type VARCHAR(20) NOT NULL CHECK (message_type IN ('TEXT', 'IMAGE', 'VIDEO', 'AUDIO', 'FILE', 'LOCATION', 'CARD')),
    content TEXT NOT NULL,
    client_msg_id VARCHAR(50) UNIQUE,
    status VARCHAR(20) DEFAULT 'SENT' CHECK (status IN ('SENDING', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'RECALLED')),
    reply_to VARCHAR(50),
    at_user_ids BIGINT[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    recalled_at TIMESTAMP,
    read_at TIMESTAMP
);

CREATE INDEX idx_messages_sender ON messages(sender_id);
CREATE INDEX idx_messages_receiver ON messages(receiver_id);
CREATE INDEX idx_messages_group ON messages(group_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_messages_status ON messages(status);
```

### 2. message_read_statusï¼ˆæ¶ˆæ¯å·²è¯»çŠ¶æ€è¡¨ï¼‰

```sql
CREATE TABLE message_read_status (
    id BIGSERIAL PRIMARY KEY,
    message_id VARCHAR(50) NOT NULL,
    user_id BIGINT NOT NULL,
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(message_id, user_id)
);

CREATE INDEX idx_read_status_message ON message_read_status(message_id);
CREATE INDEX idx_read_status_user ON message_read_status(user_id);
```

---

## ðŸ‘¥ ç¾¤ç»„æœåŠ¡æ•°æ®åº“ (aio_group)

### 1. groupsï¼ˆç¾¤ç»„è¡¨ï¼‰

```sql
CREATE TABLE groups (
    group_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar VARCHAR(500),
    owner_id BIGINT NOT NULL,
    member_count INT DEFAULT 0,
    max_members INT DEFAULT 500,
    join_type VARCHAR(20) DEFAULT 'FREE' CHECK (join_type IN ('FREE', 'APPROVAL', 'INVITE_ONLY')),
    announcement TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_groups_owner ON groups(owner_id);
CREATE INDEX idx_groups_created_at ON groups(created_at);
```

### 2. group_membersï¼ˆç¾¤ç»„æˆå‘˜è¡¨ï¼‰

```sql
CREATE TABLE group_members (
    id BIGSERIAL PRIMARY KEY,
    group_id VARCHAR(50) NOT NULL REFERENCES groups(group_id),
    user_id BIGINT NOT NULL,
    role VARCHAR(20) DEFAULT 'MEMBER' CHECK (role IN ('OWNER', 'ADMIN', 'MEMBER')),
    nickname VARCHAR(50),
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(group_id, user_id)
);

CREATE INDEX idx_group_members_group ON group_members(group_id);
CREATE INDEX idx_group_members_user ON group_members(user_id);
CREATE INDEX idx_group_members_role ON group_members(role);
```

---

## ðŸ“… æ—¥ç¨‹æœåŠ¡æ•°æ®åº“ (aio_calendar)

### 1. calendar_eventsï¼ˆæ—¥ç¨‹è¡¨ï¼‰

```sql
CREATE TABLE calendar_events (
    event_id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    location VARCHAR(200),
    event_type VARCHAR(20) CHECK (event_type IN ('MEETING', 'TASK', 'REMINDER', 'ANNIVERSARY')),
    is_all_day BOOLEAN DEFAULT FALSE,
    creator_id BIGINT NOT NULL,
    recurrence_rule JSONB,
    visibility VARCHAR(20) DEFAULT 'PUBLIC' CHECK (visibility IN ('PUBLIC', 'PRIVATE')),
    color VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_events_creator ON calendar_events(creator_id);
CREATE INDEX idx_events_start_time ON calendar_events(start_time);
CREATE INDEX idx_events_end_time ON calendar_events(end_time);
CREATE INDEX idx_events_type ON calendar_events(event_type);
```

### 2. event_attendeesï¼ˆæ—¥ç¨‹å‚ä¸Žäººè¡¨ï¼‰

```sql
CREATE TABLE event_attendees (
    id BIGSERIAL PRIMARY KEY,
    event_id VARCHAR(50) NOT NULL REFERENCES calendar_events(event_id),
    user_id BIGINT NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'DECLINED', 'TENTATIVE')),
    comment TEXT,
    responded_at TIMESTAMP,
    UNIQUE(event_id, user_id)
);

CREATE INDEX idx_attendees_event ON event_attendees(event_id);
CREATE INDEX idx_attendees_user ON event_attendees(user_id);
CREATE INDEX idx_attendees_status ON event_attendees(status);
```

---

## âœ… ä»»åŠ¡æœåŠ¡æ•°æ®åº“ (aio_task)

### 1. tasksï¼ˆä»»åŠ¡è¡¨ï¼‰

```sql
CREATE TABLE tasks (
    task_id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'TODO' CHECK (status IN ('TODO', 'IN_PROGRESS', 'DONE', 'CLOSED', 'CANCELLED')),
    priority VARCHAR(20) DEFAULT 'MEDIUM' CHECK (priority IN ('URGENT', 'HIGH', 'MEDIUM', 'LOW')),
    progress INT DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
    creator_id BIGINT NOT NULL,
    assignee_id BIGINT,
    project_id VARCHAR(50),
    parent_task_id VARCHAR(50),
    due_date TIMESTAMP,
    estimated_hours DECIMAL(10,2),
    actual_hours DECIMAL(10,2),
    tags VARCHAR(50)[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_tasks_creator ON tasks(creator_id);
CREATE INDEX idx_tasks_assignee ON tasks(assignee_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_project ON tasks(project_id);
```

### 2. task_commentsï¼ˆä»»åŠ¡è¯„è®ºè¡¨ï¼‰

```sql
CREATE TABLE task_comments (
    comment_id VARCHAR(50) PRIMARY KEY,
    task_id VARCHAR(50) NOT NULL REFERENCES tasks(task_id),
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    at_user_ids BIGINT[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_task_comments_task ON task_comments(task_id);
CREATE INDEX idx_task_comments_user ON task_comments(user_id);
```

---

## ðŸŽ¥ ä¼šè®®æœåŠ¡æ•°æ®åº“ (aio_meeting)

### 1. meetingsï¼ˆä¼šè®®è¡¨ï¼‰

```sql
CREATE TABLE meetings (
    meeting_id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    meeting_number VARCHAR(20) UNIQUE NOT NULL,
    meeting_type VARCHAR(20) CHECK (meeting_type IN ('AUDIO', 'VIDEO', 'WEBINAR')),
    host_id BIGINT NOT NULL,
    start_time TIMESTAMP NOT NULL,
    duration INT NOT NULL,
    status VARCHAR(20) DEFAULT 'SCHEDULED' CHECK (status IN ('SCHEDULED', 'STARTED', 'ENDED', 'CANCELLED')),
    join_url VARCHAR(500),
    password VARCHAR(20),
    recording_url VARCHAR(500),
    settings JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_meetings_host ON meetings(host_id);
CREATE INDEX idx_meetings_start_time ON meetings(start_time);
CREATE INDEX idx_meetings_status ON meetings(status);
```

---

## ðŸ“ å®¡æ‰¹æœåŠ¡æ•°æ®åº“ (aio_approval)

### 1. approvalsï¼ˆå®¡æ‰¹è¡¨ï¼‰

```sql
CREATE TABLE approvals (
    approval_id VARCHAR(50) PRIMARY KEY,
    template_id VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    applicant_id BIGINT NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED', 'EXPIRED')),
    form_data JSONB NOT NULL,
    current_node VARCHAR(100),
    current_approvers BIGINT[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_approvals_applicant ON approvals(applicant_id);
CREATE INDEX idx_approvals_status ON approvals(status);
CREATE INDEX idx_approvals_template ON approvals(template_id);
```

### 2. approval_historyï¼ˆå®¡æ‰¹åŽ†å²è¡¨ï¼‰

```sql
CREATE TABLE approval_history (
    id BIGSERIAL PRIMARY KEY,
    approval_id VARCHAR(50) NOT NULL REFERENCES approvals(approval_id),
    approver_id BIGINT NOT NULL,
    action VARCHAR(20) CHECK (action IN ('APPROVE', 'REJECT', 'TRANSFER', 'WITHDRAW')),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_approval_history_approval ON approval_history(approval_id);
CREATE INDEX idx_approval_history_approver ON approval_history(approver_id);
```

---

## ðŸ¢ ç»„ç»‡æž¶æž„æ•°æ®åº“ (aio_organization)

### 1. departmentsï¼ˆéƒ¨é—¨è¡¨ï¼‰

```sql
CREATE TABLE departments (
    department_id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id BIGINT REFERENCES departments(department_id),
    description TEXT,
    leader_id BIGINT,
    order_num INT DEFAULT 0,
    level INT DEFAULT 1,
    full_path VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_departments_parent ON departments(parent_id);
CREATE INDEX idx_departments_leader ON departments(leader_id);
CREATE INDEX idx_departments_level ON departments(level);
```

### 2. department_membersï¼ˆéƒ¨é—¨æˆå‘˜è¡¨ï¼‰

```sql
CREATE TABLE department_members (
    id BIGSERIAL PRIMARY KEY,
    department_id BIGINT NOT NULL REFERENCES departments(department_id),
    user_id BIGINT NOT NULL,
    position VARCHAR(100),
    is_leader BOOLEAN DEFAULT FALSE,
    is_main BOOLEAN DEFAULT TRUE,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(department_id, user_id)
);

CREATE INDEX idx_dept_members_dept ON department_members(department_id);
CREATE INDEX idx_dept_members_user ON department_members(user_id);
```

---

## ðŸ”§ æ•°æ®åº“ç»´æŠ¤

### å®šæœŸä»»åŠ¡

```sql
-- æ¸…ç†è¿‡æœŸçš„ç™»å½•æ—¥å¿—ï¼ˆä¿ç•™90å¤©ï¼‰
DELETE FROM login_logs WHERE login_at < NOW() - INTERVAL '90 days';

-- æ¸…ç†å·²åˆ é™¤çš„æ¶ˆæ¯ï¼ˆä¿ç•™30å¤©ï¼‰
DELETE FROM messages WHERE status = 'DELETED' AND updated_at < NOW() - INTERVAL '30 days';

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;
ANALYZE messages;
ANALYZE groups;
```

### å¤‡ä»½ç­–ç•¥
- **å…¨é‡å¤‡ä»½**: æ¯å¤©å‡Œæ™¨2ç‚¹
- **å¢žé‡å¤‡ä»½**: æ¯å°æ—¶
- **ä¿ç•™æ—¶é—´**: 30å¤©

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åŽæ›´æ–°**: 2025-11-11  
**ç»´æŠ¤äºº**: æ•°æ®åº“å›¢é˜Ÿ

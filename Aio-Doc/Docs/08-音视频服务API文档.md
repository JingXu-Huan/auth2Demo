# éŸ³è§†é¢‘æœåŠ¡ API æ–‡æ¡£

## ğŸ“‹ æœåŠ¡åŠŸèƒ½è¯´æ˜

éŸ³è§†é¢‘æœåŠ¡ï¼ˆRTCï¼‰ä¸ºIMç³»ç»Ÿæä¾›å®æ—¶éŸ³è§†é¢‘é€šè¯èƒ½åŠ›ï¼Œæ”¯æŒä¸€å¯¹ä¸€è¯­éŸ³/è§†é¢‘é€šè¯ã€å¤šäººéŸ³è§†é¢‘ä¼šè®®ç­‰åŠŸèƒ½ã€‚æœ¬æœåŠ¡åŸºäºWebRTCæŠ€æœ¯ï¼Œæä¾›ä½å»¶è¿Ÿã€é«˜è´¨é‡çš„å®æ—¶é€šä¿¡ä½“éªŒï¼Œå¹¶æ”¯æŒå±å¹•å…±äº«ã€å½•åˆ¶ã€ç¾é¢œç­‰é«˜çº§åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. è¯­éŸ³é€šè¯
- **ä¸€å¯¹ä¸€é€šè¯**: é«˜æ¸…è¯­éŸ³é€šè¯ï¼Œä½å»¶è¿Ÿ
- **å¤šäººè¯­éŸ³**: æ”¯æŒæœ€å¤š50äººåŒæ—¶è¯­éŸ³
- **é€šè¯è´¨é‡**: è‡ªé€‚åº”ç ç‡ï¼Œä¿è¯é€šè¯è´¨é‡
- **é™å™ªå¤„ç†**: AIé™å™ªï¼Œæ¶ˆé™¤èƒŒæ™¯å™ªéŸ³
- **å›éŸ³æ¶ˆé™¤**: è‡ªåŠ¨å›éŸ³æ¶ˆé™¤

#### 2. è§†é¢‘é€šè¯
- **ä¸€å¯¹ä¸€è§†é¢‘**: 720P/1080Pé«˜æ¸…è§†é¢‘
- **å¤šäººè§†é¢‘**: æ”¯æŒæœ€å¤š16äººè§†é¢‘ä¼šè®®
- **ç”»é¢å¸ƒå±€**: å®«æ ¼ã€æ¼”è®²è€…ã€ç”»ä¸­ç”»ç­‰å¤šç§å¸ƒå±€
- **ç¾é¢œæ»¤é•œ**: å®æ—¶ç¾é¢œã€æ»¤é•œæ•ˆæœ
- **è™šæ‹ŸèƒŒæ™¯**: èƒŒæ™¯è™šåŒ–ã€è‡ªå®šä¹‰èƒŒæ™¯

#### 3. å±å¹•å…±äº«
- **å…¨å±å…±äº«**: å…±äº«æ•´ä¸ªå±å¹•
- **çª—å£å…±äº«**: å…±äº«æŒ‡å®šåº”ç”¨çª—å£
- **æ ‡æ³¨åŠŸèƒ½**: å±å¹•æ ‡æ³¨ã€ç”»ç¬”å·¥å…·
- **è¿œç¨‹æ§åˆ¶**: æˆæƒè¿œç¨‹æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

#### 4. ä¼šè®®ç®¡ç†
- **åˆ›å»ºä¼šè®®**: å¿«é€Ÿåˆ›å»ºéŸ³è§†é¢‘ä¼šè®®
- **ä¼šè®®é‚€è¯·**: é‚€è¯·é“¾æ¥ã€ä¼šè®®å·
- **ä¼šè®®æ§åˆ¶**: ä¸»æŒäººæ§åˆ¶ï¼ˆé™éŸ³ã€è¸¢äººã€é”å®šï¼‰
- **ä¸¾æ‰‹å‘è¨€**: å‚ä¼šè€…ä¸¾æ‰‹ç”³è¯·å‘è¨€
- **ä¼šè®®å½•åˆ¶**: äº‘ç«¯å½•åˆ¶ä¼šè®®å†…å®¹

#### 5. é€šè¯åŠŸèƒ½
- **å‘¼å«/æ¥å¬**: å‘èµ·å‘¼å«ã€æ¥å¬ã€æ‹’ç»ã€æŒ‚æ–­
- **é€šè¯ä¿æŒ**: é€šè¯ä¿æŒã€æ¢å¤
- **é€šè¯è½¬æ¥**: è½¬æ¥ç»™å…¶ä»–ç”¨æˆ·
- **å¤šæ–¹é€šè¯**: é€šè¯ä¸­æ·»åŠ å…¶ä»–æˆå‘˜
- **é€šè¯è®°å½•**: è®°å½•æ‰€æœ‰é€šè¯å†å²

#### 6. ç½‘ç»œä¼˜åŒ–
- **è‡ªé€‚åº”ç ç‡**: æ ¹æ®ç½‘ç»œè‡ªåŠ¨è°ƒæ•´ç ç‡
- **å¼±ç½‘ä¼˜åŒ–**: å¼±ç½‘ç¯å¢ƒä¸‹ä¿è¯é€šè¯è´¨é‡
- **æ–­çº¿é‡è¿**: ç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¿
- **ä¸¢åŒ…è¡¥å¿**: FECå‰å‘çº é”™ã€ARQé‡ä¼ 

### æŠ€æœ¯ç‰¹æ€§
- **é€šä¿¡åè®®**: WebRTC
- **ä¿¡ä»¤æœåŠ¡**: WebSocket + SDP/ICE
- **åª’ä½“æœåŠ¡å™¨**: Janus / Kurento
- **TURNæœåŠ¡**: Coturnï¼ˆNATç©¿é€ï¼‰
- **å½•åˆ¶å­˜å‚¨**: OSSï¼ˆäº‘ç«¯å½•åˆ¶ï¼‰
- **æœåŠ¡å‘ç°**: Nacos

---

## æœåŠ¡ä¿¡æ¯
- **æœåŠ¡åç§°**: rtc-service
- **ç«¯å£**: 8008
- **åŸºç¡€è·¯å¾„**: /api/v1/rtc
- **ç‰ˆæœ¬**: v1.0.0

---

## æ ¸å¿ƒæ¥å£

### 1. å‘èµ·é€šè¯
- **URL**: `/call/initiate`
- **Method**: `POST`
- **åŠŸèƒ½**: å‘èµ·éŸ³è§†é¢‘é€šè¯

**Request**:
```json
{
  "callerId": 10001,
  "calleeId": 10002,
  "callType": "VIDEO"
}
```

**Response**:
```json
{
  "code": 200,
  "message": "é€šè¯å‘èµ·æˆåŠŸ",
  "data": {
    "callId": "call_123456",
    "callerId": 10001,
    "calleeId": 10002,
    "callType": "VIDEO",
    "status": "CALLING",
    "createdAt": "2025-11-09T15:00:00Z"
  }
}
```

---

### 2. æ¥å¬é€šè¯
- **URL**: `/call/answer`
- **Method**: `POST`
- **åŠŸèƒ½**: æ¥å¬é€šè¯

**Request**:
```json
{
  "callId": "call_123456",
  "userId": 10002
}
```

**Response**:
```json
{
  "code": 200,
  "message": "æ¥å¬æˆåŠŸ",
  "data": {
    "callId": "call_123456",
    "status": "CONNECTED",
    "connectedAt": "2025-11-09T15:00:30Z"
  }
}
```

---

### 3. æ‹’ç»é€šè¯
- **URL**: `/call/reject`
- **Method**: `POST`
- **åŠŸèƒ½**: æ‹’ç»é€šè¯

**Request**:
```json
{
  "callId": "call_123456",
  "userId": 10002,
  "reason": "BUSY"
}
```

**Response**:
```json
{
  "code": 200,
  "message": "å·²æ‹’ç»",
  "data": null
}
```

---

### 4. æŒ‚æ–­é€šè¯
- **URL**: `/call/hangup`
- **Method**: `POST`
- **åŠŸèƒ½**: æŒ‚æ–­é€šè¯

**Request**:
```json
{
  "callId": "call_123456",
  "userId": 10001
}
```

**Response**:
```json
{
  "code": 200,
  "message": "é€šè¯å·²ç»“æŸ",
  "data": {
    "callId": "call_123456",
    "duration": 120,
    "endedAt": "2025-11-09T15:02:30Z"
  }
}
```

---

### 5. è·å–é€šè¯è®°å½•
- **URL**: `/call/history`
- **Method**: `GET`
- **åŠŸèƒ½**: è·å–é€šè¯å†å²è®°å½•

**Request**:
```
GET /api/v1/rtc/call/history?userId=10001&page=1&size=20
```

**Response**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 30,
    "page": 1,
    "size": 20,
    "records": [
      {
        "callId": "call_123456",
        "callerId": 10001,
        "callerName": "å¼ ä¸‰",
        "calleeId": 10002,
        "calleeName": "æå››",
        "callType": "VIDEO",
        "status": "COMPLETED",
        "duration": 120,
        "startTime": "2025-11-09T15:00:00Z",
        "endTime": "2025-11-09T15:02:00Z"
      }
    ]
  }
}
```

---

### 6. è·å–WebRTCé…ç½®
- **URL**: `/config/webrtc`
- **Method**: `GET`
- **åŠŸèƒ½**: è·å–WebRTCè¿æ¥é…ç½®

**Response**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "iceServers": [
      {
        "urls": "stun:stun.example.com:3478"
      },
      {
        "urls": "turn:turn.example.com:3478",
        "username": "user",
        "credential": "pass"
      }
    ],
    "sdpSemantics": "unified-plan"
  }
}
```

---

## é€šè¯ç±»å‹

| ç±»å‹ | è¯´æ˜ |
|------|------|
| AUDIO | è¯­éŸ³é€šè¯ |
| VIDEO | è§†é¢‘é€šè¯ |

---

## é€šè¯çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| CALLING | å‘¼å«ä¸­ |
| RINGING | å“é“ƒä¸­ |
| CONNECTED | å·²æ¥é€š |
| COMPLETED | å·²å®Œæˆ |
| REJECTED | å·²æ‹’ç» |
| MISSED | æœªæ¥å¬ |
| CANCELLED | å·²å–æ¶ˆ |

---

## æ‹’ç»åŸå› 

| åŸå›  | è¯´æ˜ |
|------|------|
| BUSY | å¿™ç¢Œ |
| DECLINED | ä¸»åŠ¨æ‹’ç» |
| NO_ANSWER | æ— åº”ç­” |

---

## WebRTCé›†æˆç¤ºä¾‹

```javascript
// 1. è·å–WebRTCé…ç½®
const config = await fetch('/api/v1/rtc/config/webrtc').then(r => r.json())

// 2. åˆ›å»ºPeerConnection
const pc = new RTCPeerConnection(config.data)

// 3. è·å–æœ¬åœ°åª’ä½“æµ
const localStream = await navigator.mediaDevices.getUserMedia({
  video: true,
  audio: true
})

// 4. æ·»åŠ åˆ°PeerConnection
localStream.getTracks().forEach(track => {
  pc.addTrack(track, localStream)
})

// 5. åˆ›å»ºOffer
const offer = await pc.createOffer()
await pc.setLocalDescription(offer)

// 6. å‘é€Offeråˆ°å¯¹æ–¹
// é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€
```

---

## æ•°æ®æ¨¡å‹

```typescript
interface CallRecord {
  callId: string;
  callerId: number;
  callerName: string;
  calleeId: number;
  calleeName: string;
  callType: 'AUDIO' | 'VIDEO';
  status: CallStatus;
  duration: number;
  startTime: string;
  endTime: string;
}

type CallStatus = 'CALLING' | 'RINGING' | 'CONNECTED' | 'COMPLETED' | 'REJECTED' | 'MISSED' | 'CANCELLED';
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-11-09  
**ç»´æŠ¤äºº**: å¼€å‘å›¢é˜Ÿ

# å®‰å…¨è®¤è¯æŒ‡å—

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0.0
- **æœ€åæ›´æ–°**: 2025-11-11
- **ç»´æŠ¤äºº**: å®‰å…¨å›¢é˜Ÿ

---

## ğŸ” è®¤è¯ä½“ç³»æ¦‚è¿°

### è®¤è¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯                               â”‚
â”‚  Web / iOS / Android / PC                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 1. ç”¨æˆ·å+å¯†ç 
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Gateway (9000)                          â”‚
â”‚  - è·¯ç”±è½¬å‘                                              â”‚
â”‚  - Token éªŒè¯                                            â”‚
â”‚  - é™æµæ§åˆ¶                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 2. è½¬å‘è®¤è¯è¯·æ±‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            OAuth2-auth-server (8080)                     â”‚
â”‚  - OAuth2 å¯†ç æ¨¡å¼                                       â”‚
â”‚  - JWT Token ç”Ÿæˆ                                        â”‚
â”‚  - Refresh Token                                         â”‚
â”‚  - Redis Token å­˜å‚¨                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 3. è¿”å› Token
                     â†“
                  å®¢æˆ·ç«¯å­˜å‚¨ Token
                     â”‚
                     â”‚ 4. æºå¸¦ Token è®¿é—®
                     â†“
                  Gateway éªŒè¯
                     â”‚
                     â”‚ 5. è½¬å‘åˆ°ä¸šåŠ¡æœåŠ¡
                     â†“
              å„å¾®æœåŠ¡å¤„ç†ä¸šåŠ¡
```

---

## ğŸ¯ OAuth2 è®¤è¯æµç¨‹

### 1. å¯†ç æ¨¡å¼ï¼ˆPassword Grantï¼‰

#### æµç¨‹å›¾
```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
  â†“
POST /oauth/token
  â†“
éªŒè¯ client_id + client_secret
  â†“
éªŒè¯ç”¨æˆ·å + å¯†ç 
  â†“
æ£€æŸ¥é‚®ç®±æ˜¯å¦éªŒè¯
  â†“
æ£€æŸ¥è´¦å·çŠ¶æ€
  â†“
ç”Ÿæˆ access_token (JWT)
  â†“
ç”Ÿæˆ refresh_token
  â†“
å­˜å‚¨åˆ° Redis
  â†“
è¿”å› Token
```

#### è¯·æ±‚ç¤ºä¾‹
```bash
curl -X POST http://localhost:8080/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "username=user@example.com" \
  -d "password=Test@123" \
  -d "client_id=client" \
  -d "client_secret=secret"
```

#### å“åº”ç¤ºä¾‹
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "refresh_token": "refresh_token_xxx",
  "expires_in": 7200,
  "scope": "read write"
}
```

### 2. åˆ·æ–°ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰

#### è¯·æ±‚ç¤ºä¾‹
```bash
curl -X POST http://localhost:8080/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=refresh_token" \
  -d "refresh_token=refresh_token_xxx" \
  -d "client_id=client" \
  -d "client_secret=secret"
```

---

## ğŸ”‘ JWT Token è¯¦è§£

### Token ç»“æ„
```
Header.Payload.Signature
```

### Headerï¼ˆå¤´éƒ¨ï¼‰
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### Payloadï¼ˆè´Ÿè½½ï¼‰
```json
{
  "user_name": "user@example.com",
  "scope": ["read", "write"],
  "exp": 1699612345,
  "authorities": ["ROLE_USER"],
  "jti": "token-uuid",
  "client_id": "client"
}
```

### Signatureï¼ˆç­¾åï¼‰
```
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret
)
```

---

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

### 1. å¯†ç å®‰å…¨

#### å¯†ç å¼ºåº¦è¦æ±‚
- âœ… æœ€å°‘ 8 ä½
- âœ… å¿…é¡»åŒ…å«å¤§å†™å­—æ¯
- âœ… å¿…é¡»åŒ…å«å°å†™å­—æ¯
- âœ… å¿…é¡»åŒ…å«æ•°å­—
- âœ… å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦

#### å¯†ç åŠ å¯†
```java
// BCrypt åŠ å¯†
String hashedPassword = BCrypt.hashpw(plainPassword, BCrypt.gensalt(10));

// éªŒè¯å¯†ç 
boolean isValid = BCrypt.checkpw(plainPassword, hashedPassword);
```

#### å¯†ç å†å²
- è®°å½•æœ€è¿‘ 5 æ¬¡å¯†ç 
- ä¸å…è®¸é‡å¤ä½¿ç”¨æ—§å¯†ç 

### 2. ç™»å½•ä¿æŠ¤

#### å¤±è´¥æ¬¡æ•°é™åˆ¶
```java
// 5æ¬¡å¤±è´¥é”å®š15åˆ†é’Ÿ
@Service
public class LoginAttemptService {
    private static final int MAX_ATTEMPTS = 5;
    private static final int LOCK_TIME_MINUTES = 15;
    
    public void loginFailed(String email) {
        int attempts = getAttempts(email);
        if (attempts >= MAX_ATTEMPTS) {
            lockAccount(email, LOCK_TIME_MINUTES);
        }
    }
}
```

#### IP é™æµ
- åŒä¸€ IP æ¯åˆ†é’Ÿæœ€å¤š 10 æ¬¡ç™»å½•å°è¯•
- ä½¿ç”¨ Sentinel å®ç°

### 3. Token å®‰å…¨

#### Token æœ‰æ•ˆæœŸ
- **Access Token**: 2 å°æ—¶
- **Refresh Token**: 7 å¤©

#### Token å­˜å‚¨
```java
// Redis å­˜å‚¨
redisTemplate.opsForValue().set(
    "token:" + tokenValue,
    userDetails,
    2, TimeUnit.HOURS
);
```

#### Token æ’¤é”€
```java
// é€€å‡ºç™»å½•æ—¶åˆ é™¤ Token
@PostMapping("/logout")
public void logout(@RequestHeader("Authorization") String token) {
    String tokenValue = token.replace("Bearer ", "");
    redisTemplate.delete("token:" + tokenValue);
}
```

### 4. é‚®ç®±éªŒè¯

#### éªŒè¯æµç¨‹
```
ç”¨æˆ·æ³¨å†Œ
  â†“
å‘é€éªŒè¯é‚®ä»¶
  â†“
ç”¨æˆ·ç‚¹å‡»é“¾æ¥
  â†“
éªŒè¯ Token
  â†“
æ ‡è®°é‚®ç®±å·²éªŒè¯
  â†“
å…è®¸ç™»å½•
```

#### éªŒè¯ç æœ‰æ•ˆæœŸ
- **é‚®ç®±éªŒè¯ç **: 30 åˆ†é’Ÿ
- **çŸ­ä¿¡éªŒè¯ç **: 5 åˆ†é’Ÿ

---

## ğŸ”’ æƒé™æ§åˆ¶

### 1. è§’è‰²å®šä¹‰

| è§’è‰² | æƒé™ | è¯´æ˜ |
|------|------|------|
| ROLE_USER | åŸºç¡€æƒé™ | æ™®é€šç”¨æˆ· |
| ROLE_ADMIN | ç®¡ç†æƒé™ | ç®¡ç†å‘˜ |
| ROLE_SUPER_ADMIN | è¶…çº§ç®¡ç†å‘˜ | ç³»ç»Ÿç®¡ç†å‘˜ |

### 2. æƒé™æ³¨è§£

```java
// æ–¹æ³•çº§æƒé™æ§åˆ¶
@PreAuthorize("hasRole('ADMIN')")
@GetMapping("/admin/users")
public List<User> getAllUsers() {
    return userService.findAll();
}

// å¤šè§’è‰²
@PreAuthorize("hasAnyRole('ADMIN', 'SUPER_ADMIN')")
@DeleteMapping("/users/{id}")
public void deleteUser(@PathVariable Long id) {
    userService.delete(id);
}

// è‡ªå®šä¹‰æƒé™
@PreAuthorize("@permissionService.canEdit(#userId)")
@PutMapping("/users/{userId}")
public void updateUser(@PathVariable Long userId) {
    // ...
}
```

### 3. èµ„æºçº§æƒé™

```java
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®èµ„æº
public boolean canAccessResource(Long userId, Long resourceId) {
    Resource resource = resourceRepository.findById(resourceId);
    return resource.getOwnerId().equals(userId) 
        || resource.getSharedUsers().contains(userId);
}
```

---

## ğŸŒ è·¨åŸŸé…ç½®

### CORS é…ç½®
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("http://localhost:3000");
        config.addAllowedOrigin("https://app.example.com");
        config.addAllowedMethod("*");
        config.addAllowedHeader("*");
        config.setAllowCredentials(true);
        config.setMaxAge(3600L);
        
        UrlBasedCorsConfigurationSource source = 
            new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        
        return new CorsFilter(source);
    }
}
```

---

## ğŸ” HTTPS é…ç½®

### SSL è¯ä¹¦é…ç½®
```yaml
server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: changeit
    key-store-type: PKCS12
    key-alias: tomcat
```

### å¼ºåˆ¶ HTTPS
```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.requiresChannel()
            .anyRequest()
            .requiresSecure();
    }
}
```

---

## ğŸ›¡ï¸ é˜²æŠ¤æªæ–½

### 1. XSS é˜²æŠ¤
```java
// è¾“å…¥è¿‡æ»¤
public String sanitizeInput(String input) {
    return StringEscapeUtils.escapeHtml4(input);
}
```

### 2. CSRF é˜²æŠ¤
```java
http.csrf()
    .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());
```

### 3. SQL æ³¨å…¥é˜²æŠ¤
```java
// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
@Query("SELECT u FROM User u WHERE u.email = :email")
User findByEmail(@Param("email") String email);
```

### 4. æ•æ„Ÿä¿¡æ¯è„±æ•
```java
// æ‰‹æœºå·è„±æ•
public String maskPhone(String phone) {
    return phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
}

// é‚®ç®±è„±æ•
public String maskEmail(String email) {
    return email.replaceAll("(\\w{1})\\w+(@\\w+)", "$1***$2");
}
```

---

## ğŸ“± å¤šè®¾å¤‡ç®¡ç†

### è®¾å¤‡ç™»å½•
```java
@PostMapping("/login")
public LoginResponse login(@RequestBody LoginRequest request) {
    // è®°å½•è®¾å¤‡ä¿¡æ¯
    DeviceInfo device = DeviceInfo.builder()
        .userId(user.getId())
        .deviceType(request.getDeviceType())
        .deviceId(request.getDeviceId())
        .ip(getClientIp())
        .userAgent(getUserAgent())
        .build();
    
    deviceService.save(device);
    
    return LoginResponse.builder()
        .token(token)
        .deviceId(device.getId())
        .build();
}
```

### è®¾å¤‡ç®¡ç†
```java
// æŸ¥çœ‹ç™»å½•è®¾å¤‡
@GetMapping("/devices")
public List<Device> getDevices() {
    return deviceService.findByUserId(getCurrentUserId());
}

// è¸¢å‡ºè®¾å¤‡
@DeleteMapping("/devices/{deviceId}")
public void kickDevice(@PathVariable Long deviceId) {
    deviceService.logout(deviceId);
}
```

---

## ğŸ” å®¡è®¡æ—¥å¿—

### ç™»å½•æ—¥å¿—
```java
@Aspect
@Component
public class LoginAuditAspect {
    @AfterReturning("@annotation(LoginAudit)")
    public void logLogin(JoinPoint joinPoint) {
        LoginLog log = LoginLog.builder()
            .userId(userId)
            .ip(ip)
            .userAgent(userAgent)
            .success(true)
            .timestamp(LocalDateTime.now())
            .build();
        
        loginLogRepository.save(log);
    }
}
```

### æ“ä½œæ—¥å¿—
```java
@PostMapping("/users/{id}")
@OperationLog(type = "UPDATE_USER")
public void updateUser(@PathVariable Long id) {
    // è®°å½•æ“ä½œ
    auditService.log(
        "UPDATE_USER",
        "ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯",
        id
    );
}
```

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. Token ä½¿ç”¨
- âœ… ä½¿ç”¨ HTTPS ä¼ è¾“
- âœ… ä¸åœ¨ URL ä¸­ä¼ é€’ Token
- âœ… ä½¿ç”¨ Authorization Header
- âœ… å®šæœŸåˆ·æ–° Token
- âœ… é€€å‡ºæ—¶æ¸…é™¤ Token

### 2. å¯†ç ç®¡ç†
- âœ… ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- âœ… å®šæœŸæé†’ä¿®æ”¹å¯†ç 
- âœ… ä¸å­˜å‚¨æ˜æ–‡å¯†ç 
- âœ… ä½¿ç”¨ BCrypt åŠ å¯†
- âœ… è®°å½•å¯†ç å†å²

### 3. ä¼šè¯ç®¡ç†
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- âœ… æ”¯æŒå•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- âœ… æ”¯æŒå¤šè®¾å¤‡ç®¡ç†
- âœ… å¼‚å¸¸ç™»å½•æ£€æµ‹

### 4. å®‰å…¨æ£€æŸ¥æ¸…å•
- [ ] æ‰€æœ‰æ¥å£éƒ½éœ€è¦è®¤è¯
- [ ] æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯
- [ ] å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬
- [ ] å®šæœŸå®‰å…¨æ‰«æ
- [ ] å®šæœŸå¤‡ä»½æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-11-11  
**ç»´æŠ¤äºº**: å®‰å…¨å›¢é˜Ÿ

# æ¶ˆæ¯æœåŠ¡ API æ–‡æ¡£

## ğŸ“‹ æœåŠ¡åŠŸèƒ½è¯´æ˜

æ¶ˆæ¯æœåŠ¡æ˜¯IMç³»ç»Ÿçš„æ ¸å¿ƒé€šä¿¡æœåŠ¡ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰å³æ—¶æ¶ˆæ¯çš„å‘é€ã€æ¥æ”¶ã€å­˜å‚¨å’ŒåŒæ­¥ã€‚æœ¬æœåŠ¡åŸºäºWebSocketå®ç°å®æ—¶åŒå‘é€šä¿¡ï¼Œæ”¯æŒå•èŠã€ç¾¤èŠã€å¤šåª’ä½“æ¶ˆæ¯ç­‰å¤šç§æ¶ˆæ¯ç±»å‹ï¼Œå¹¶æä¾›å®Œæ•´çš„æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. å®æ—¶æ¶ˆæ¯é€šä¿¡
- **WebSocketè¿æ¥**: å»ºç«‹æŒä¹…åŒ–åŒå‘é€šä¿¡é€šé“ï¼Œæ”¯æŒå¿ƒè·³ä¿æ´»
- **å•èŠæ¶ˆæ¯**: ä¸€å¯¹ä¸€å®æ—¶æ¶ˆæ¯å‘é€ä¸æ¥æ”¶
- **ç¾¤èŠæ¶ˆæ¯**: ç¾¤ç»„å†…æ¶ˆæ¯å¹¿æ’­ï¼Œæ”¯æŒ@æé†’
- **æ¶ˆæ¯æ¨é€**: ç¦»çº¿æ¶ˆæ¯æ¨é€ã€æœªè¯»æ¶ˆæ¯æé†’

#### 2. å¤šåª’ä½“æ¶ˆæ¯æ”¯æŒ
- **æ–‡æœ¬æ¶ˆæ¯**: çº¯æ–‡æœ¬ã€è¡¨æƒ…ã€è¶…é“¾æ¥ã€@æé†’
- **å›¾ç‰‡æ¶ˆæ¯**: æ”¯æŒå¤šå›¾å‘é€ã€å›¾ç‰‡å‹ç¼©ã€ç¼©ç•¥å›¾
- **è¯­éŸ³æ¶ˆæ¯**: è¯­éŸ³å½•åˆ¶ã€æ’­æ”¾ã€æ—¶é•¿æ˜¾ç¤º
- **è§†é¢‘æ¶ˆæ¯**: çŸ­è§†é¢‘å‘é€ã€å°é¢å›¾ã€æ—¶é•¿é™åˆ¶
- **æ–‡ä»¶æ¶ˆæ¯**: æ–‡æ¡£ã€å‹ç¼©åŒ…ç­‰æ–‡ä»¶ä¼ è¾“
- **ä½ç½®æ¶ˆæ¯**: åœ°ç†ä½ç½®åˆ†äº«
- **å¡ç‰‡æ¶ˆæ¯**: åç‰‡ã€é“¾æ¥å¡ç‰‡ã€å°ç¨‹åºå¡ç‰‡

#### 3. æ¶ˆæ¯ç®¡ç†
- **æ¶ˆæ¯æ’¤å›**: 2åˆ†é’Ÿå†…å¯æ’¤å›ï¼Œæ˜¾ç¤ºæ’¤å›æç¤º
- **æ¶ˆæ¯åˆ é™¤**: å•æ¡åˆ é™¤ã€æ‰¹é‡åˆ é™¤ï¼ˆä»…æœ¬åœ°ï¼‰
- **æ¶ˆæ¯è½¬å‘**: å•æ¡è½¬å‘ã€åˆå¹¶è½¬å‘
- **æ¶ˆæ¯å¼•ç”¨**: å›å¤ç‰¹å®šæ¶ˆæ¯ï¼Œæ˜¾ç¤ºå¼•ç”¨å†…å®¹
- **æ¶ˆæ¯æ”¶è—**: é‡è¦æ¶ˆæ¯æ”¶è—ï¼Œè·¨è®¾å¤‡åŒæ­¥
- **æ¶ˆæ¯ç½®é¡¶**: ä¼šè¯ç½®é¡¶ã€æ¶ˆæ¯ç½®é¡¶

#### 4. æ¶ˆæ¯çŠ¶æ€
- **å‘é€çŠ¶æ€**: å‘é€ä¸­ã€å·²å‘é€ã€å‘é€å¤±è´¥
- **å·²è¯»å›æ‰§**: å•èŠå·²è¯»ã€ç¾¤èŠå·²è¯»äººæ•°
- **æ­£åœ¨è¾“å…¥**: å®æ—¶æ˜¾ç¤ºå¯¹æ–¹è¾“å…¥çŠ¶æ€
- **æ¶ˆæ¯åŒæ­¥**: å¤šç«¯æ¶ˆæ¯å®æ—¶åŒæ­¥

#### 5. å†å²æ¶ˆæ¯
- **æ¶ˆæ¯å­˜å‚¨**: æ°¸ä¹…å­˜å‚¨ï¼Œæ”¯æŒäº‘ç«¯å¤‡ä»½
- **æ¶ˆæ¯æŸ¥è¯¢**: æŒ‰æ—¶é—´ã€ç±»å‹ã€å…³é”®è¯æŸ¥è¯¢
- **åˆ†é¡µåŠ è½½**: ä¸Šæ‹‰åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
- **æ¶ˆæ¯æœç´¢**: å…¨æ–‡æœç´¢ã€å‘é€è€…ç­›é€‰

#### 6. é«˜çº§åŠŸèƒ½
- **é˜…åå³ç„š**: æ¶ˆæ¯é˜…è¯»åè‡ªåŠ¨é”€æ¯
- **æ¶ˆæ¯åŠ å¯†**: ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆå¯é€‰ï¼‰
- **æ¶ˆæ¯ç¿»è¯‘**: å¤šè¯­è¨€è‡ªåŠ¨ç¿»è¯‘
- **è¡¨æƒ…å›åº”**: å¿«é€Ÿè¡¨æƒ…åé¦ˆ
- **æ¶ˆæ¯æé†’**: å…æ‰“æ‰°ã€ä»…@æé†’ã€å…¨éƒ¨æé†’

### æŠ€æœ¯ç‰¹æ€§
- **é€šä¿¡åè®®**: WebSocket + STOMP
- **æ¶ˆæ¯é˜Ÿåˆ—**: RabbitMQï¼ˆæ¶ˆæ¯åˆ†å‘ï¼‰
- **æ•°æ®åº“**: MongoDBï¼ˆæ¶ˆæ¯å­˜å‚¨ï¼‰+ Redisï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰
- **æ–‡ä»¶å­˜å‚¨**: OSSï¼ˆå¤šåª’ä½“æ–‡ä»¶ï¼‰
- **æ¶ˆæ¯æ¨é€**: APNsï¼ˆiOSï¼‰+ FCMï¼ˆAndroidï¼‰
- **è´Ÿè½½å‡è¡¡**: Nginxï¼ˆWebSocketï¼‰
- **æœåŠ¡å‘ç°**: Nacos

---

## æœåŠ¡ä¿¡æ¯
- **æœåŠ¡åç§°**: message-service  
- **ç«¯å£**: 8002  
- **åŸºç¡€è·¯å¾„**: /api/v1/messages  
- **ç‰ˆæœ¬**: v1.0.0

**é‰´æƒæè¿°**:
å»ºç«‹WebSocketè¿æ¥
   â†“
   å‰ç«¯ â†’ IMGateway (/ws)
   â†“ æºå¸¦Token (é€šè¿‡Headeræˆ–Queryå‚æ•°)
   IMGatewayéªŒè¯Token
   â†“ (Tokenæœ‰æ•ˆ)
   å»ºç«‹WebSocketè¿æ¥

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¸¦é‰´æƒçš„å®Œæ•´æ¶ˆæ¯æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·ç™»å½•
   â†“
   å‰ç«¯ â†’ UserService.login()
   â†“
   è¿”å› JWT Token (åŒ…å«userId, username, è¿‡æœŸæ—¶é—´ç­‰)
   â†“
   å‰ç«¯å­˜å‚¨Token


2. å»ºç«‹WebSocketè¿æ¥
   â†“
   å‰ç«¯ â†’ IMGateway (/ws)
   â†“ æºå¸¦Token (é€šè¿‡Headeræˆ–Queryå‚æ•°)
   IMGatewayéªŒè¯Token
   â†“ (Tokenæœ‰æ•ˆ)
   å»ºç«‹WebSocketè¿æ¥


3. å‘é€æ¶ˆæ¯ï¼ˆå…³é”®æµç¨‹ï¼‰
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å‰ç«¯                                                      â”‚
   â”‚ stompClient.send('/app/chat/private', {}, JSON.stringify({â”‚
   â”‚   senderId: "user123",                                    â”‚
   â”‚   receiverId: "user456",                                  â”‚
   â”‚   content: "Hello"                                        â”‚
   â”‚ }))                                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ WebSocket + Token
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ IMGateway (8080)                                          â”‚
   â”‚ 1. ä»WebSocket Sessionä¸­æå–Token                        â”‚
   â”‚ 2. éªŒè¯Tokenæœ‰æ•ˆæ€§                                        â”‚
   â”‚ 3. ä»Tokenä¸­æå–çœŸå®çš„userId                              â”‚
   â”‚ 4. å¯¹æ¯”æ¶ˆæ¯ä¸­çš„senderIdæ˜¯å¦åŒ¹é…ï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ HTTPè½¬å‘ + Tokenä¼ é€’
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ChatService (8081)                                        â”‚
   â”‚ @MessageMapping("/chat/private")                          â”‚
   â”‚ public void handlePrivateMessage(                         â”‚
   â”‚     ChatMessage message,                                  â”‚
   â”‚     @Header("Authorization") String token  â† ä»Headerè·å– â”‚
   â”‚ ) {                                                       â”‚
   â”‚     // 1. éªŒè¯Tokenï¼ˆäºŒæ¬¡éªŒè¯ï¼‰                           â”‚
   â”‚     if (!tokenService.validateToken(token)) {             â”‚
   â”‚         throw new UnauthorizedException();                â”‚
   â”‚     }                                                     â”‚
   â”‚                                                           â”‚
   â”‚     // 2. ä»Tokenä¸­æå–userId                             â”‚
   â”‚     String userId = tokenService.getUserId(token);        â”‚
   â”‚                                                           â”‚
   â”‚     // 3. éªŒè¯senderIdæ˜¯å¦åŒ¹é…                            â”‚
   â”‚     if (!message.getSenderId().equals(userId)) {          â”‚
   â”‚         throw new ForbiddenException("ä¸èƒ½å†’å……ä»–äººå‘é€");  â”‚
   â”‚     }                                                     â”‚
   â”‚                                                           â”‚
   â”‚     // 4. å¤„ç†æ¶ˆæ¯                                        â”‚
   â”‚     chatService.sendPrivateMessage(message);              â”‚
   â”‚ }                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
**æµç¨‹å›¾è®¾è®¡**:
---
ç”¨æˆ·å‘é€æ¶ˆæ¯
â†“
ChatController (@MessageMapping)
â†“
ChatService.sendPrivateMessage()
â”œâ”€â†’ 1. Rediså­˜å‚¨ (å†å²è®°å½•ï¼Œä¿æŒä¸å˜)
â””â”€â†’ 2. RabbitMQå‘é€ (rabbitTemplate.convertAndSend)
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RabbitMQ Topic Exchange           â”‚
â”‚   chat.message.exchange             â”‚
â”‚   Routing Key: chat.private.{userId}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“ (å¹¿æ’­åˆ°æ‰€æœ‰é˜Ÿåˆ—)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                â†“        â†“        â†“
Queue1          Queue2    Queue3   Queue4
(å®ä¾‹1ç‹¬å )     (å®ä¾‹2)   (å®ä¾‹3)  (å®ä¾‹4)
â†“                â†“        â†“        â†“
@RabbitListener  @RabbitListener  ...
MessageConsumer.handleMessage()  â† æ›¿ä»£åŸæ¥çš„onMessage
â†“                â†“        â†“        â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿æ¥åˆ°æœ¬å®ä¾‹
â†“
SimpMessagingTemplate.convertAndSendToUser()
â†“
WebSocketæ¨é€ç»™å®¢æˆ·ç«¯
---
---

## ç›®å½•
1. [å‘é€å•èŠæ¶ˆæ¯](#1-å‘é€å•èŠæ¶ˆæ¯)
2. [å‘é€ç¾¤èŠæ¶ˆæ¯](#2-å‘é€ç¾¤èŠæ¶ˆæ¯)
3. [å‘é€å›¾ç‰‡æ¶ˆæ¯](#3-å‘é€å›¾ç‰‡æ¶ˆæ¯)
4. [è·å–å†å²æ¶ˆæ¯](#4-è·å–å†å²æ¶ˆæ¯)
5. [æ’¤å›æ¶ˆæ¯](#5-æ’¤å›æ¶ˆæ¯)
6. [æ ‡è®°æ¶ˆæ¯å·²è¯»](#6-æ ‡è®°æ¶ˆæ¯å·²è¯»)
7. [è·å–æœªè¯»æ¶ˆæ¯æ•°](#7-è·å–æœªè¯»æ¶ˆæ¯æ•°)
8. [è½¬å‘æ¶ˆæ¯](#8-è½¬å‘æ¶ˆæ¯)

---

## 1. å‘é€å•èŠæ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/private`
- **Method**: `POST`
- **åŠŸèƒ½**: å‘é€ä¸€å¯¹ä¸€ç§èŠæ¶ˆæ¯
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "receiverId": 10002,
  "messageType": "TEXT",
  "content": "ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ",
  "clientMsgId": "client_msg_123456"
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| receiverId | number | æ˜¯ | æ¥æ”¶è€…ç”¨æˆ·ID |
| messageType | string | æ˜¯ | æ¶ˆæ¯ç±»å‹ï¼šTEXT/IMAGE/VIDEO/AUDIO/FILE |
| content | string/object | æ˜¯ | æ¶ˆæ¯å†…å®¹ï¼Œæ–‡æœ¬æˆ–JSONå¯¹è±¡ |
| clientMsgId | string | æ˜¯ | å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼Œç”¨äºå»é‡ |

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "å‘é€æˆåŠŸ",
  "data": {
    "messageId": "msg_789012",
    "senderId": 10001,
    "receiverId": 10002,
    "messageType": "TEXT",
    "content": "ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ",
    "status": "SENT",
    "timestamp": "2025-11-09T15:30:00Z",
    "clientMsgId": "client_msg_123456"
  }
}
```

---

## 2. å‘é€ç¾¤èŠæ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/group`
- **Method**: `POST`
- **åŠŸèƒ½**: å‘é€ç¾¤ç»„æ¶ˆæ¯
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "groupId": "group_001",
  "messageType": "TEXT",
  "content": "å¤§å®¶å¥½ï¼",
  "atUserIds": [10002, 10003],
  "clientMsgId": "client_msg_123457"
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| groupId | string | æ˜¯ | ç¾¤ç»„ID |
| messageType | string | æ˜¯ | æ¶ˆæ¯ç±»å‹ |
| content | string/object | æ˜¯ | æ¶ˆæ¯å†…å®¹ |
| atUserIds | array | å¦ | @æé†’çš„ç”¨æˆ·IDåˆ—è¡¨ |
| clientMsgId | string | æ˜¯ | å®¢æˆ·ç«¯æ¶ˆæ¯ID |

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "å‘é€æˆåŠŸ",
  "data": {
    "messageId": "msg_789013",
    "senderId": 10001,
    "groupId": "group_001",
    "messageType": "TEXT",
    "content": "å¤§å®¶å¥½ï¼",
    "atUserIds": [10002, 10003],
    "status": "SENT",
    "timestamp": "2025-11-09T15:31:00Z"
  }
}
```

---

## 3. å‘é€å›¾ç‰‡æ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/image`
- **Method**: `POST`
- **åŠŸèƒ½**: å‘é€å›¾ç‰‡æ¶ˆæ¯
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "receiverId": 10002,
  "messageType": "IMAGE",
  "content": {
    "url": "https://cdn.example.com/images/abc123.jpg",
    "thumbnail": "https://cdn.example.com/images/abc123_thumb.jpg",
    "width": 1920,
    "height": 1080,
    "size": 524288,
    "format": "jpg"
  },
  "clientMsgId": "client_msg_123458"
}
```

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "å‘é€æˆåŠŸ",
  "data": {
    "messageId": "msg_789014",
    "senderId": 10001,
    "receiverId": 10002,
    "messageType": "IMAGE",
    "content": {
      "url": "https://cdn.example.com/images/abc123.jpg",
      "thumbnail": "https://cdn.example.com/images/abc123_thumb.jpg",
      "width": 1920,
      "height": 1080,
      "size": 524288
    },
    "timestamp": "2025-11-09T15:32:00Z"
  }
}
```

---

## 4. è·å–å†å²æ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/history`
- **Method**: `GET`
- **åŠŸèƒ½**: è·å–ä¸æŒ‡å®šç”¨æˆ·æˆ–ç¾¤ç»„çš„èŠå¤©å†å²
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```
GET /api/v1/messages/history?userId=10002&before=msg_789014&limit=20
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| userId | number | å¦ | ç”¨æˆ·IDï¼ˆå•èŠï¼‰ |
| groupId | string | å¦ | ç¾¤ç»„IDï¼ˆç¾¤èŠï¼‰ |
| before | string | å¦ | æ¶ˆæ¯IDï¼Œè·å–æ­¤æ¶ˆæ¯ä¹‹å‰çš„å†å² |
| limit | integer | å¦ | æ•°é‡é™åˆ¶ï¼Œé»˜è®¤20ï¼Œæœ€å¤§100 |

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hasMore": true,
    "messages": [
      {
        "messageId": "msg_789014",
        "senderId": 10001,
        "receiverId": 10002,
        "messageType": "TEXT",
        "content": "ä½ å¥½",
        "status": "READ",
        "timestamp": "2025-11-09T15:30:00Z"
      }
    ]
  }
}
```

---

## 5. æ’¤å›æ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/{messageId}/recall`
- **Method**: `POST`
- **åŠŸèƒ½**: æ’¤å›å·²å‘é€çš„æ¶ˆæ¯ï¼ˆ2åˆ†é’Ÿå†…ï¼‰
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "reason": "å‘é”™äº†"
}
```

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "æ’¤å›æˆåŠŸ",
  "data": {
    "messageId": "msg_789014",
    "status": "RECALLED",
    "recalledAt": "2025-11-09T15:32:00Z"
  }
}
```

### Response - å¤±è´¥
```json
{
  "code": 400,
  "message": "è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›",
  "data": null
}
```

---

## 6. æ ‡è®°æ¶ˆæ¯å·²è¯»

### æ¥å£ä¿¡æ¯
- **URL**: `/read`
- **Method**: `POST`
- **åŠŸèƒ½**: æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»çŠ¶æ€
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "messageIds": ["msg_789014", "msg_789013", "msg_789012"]
}
```

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "å·²æ ‡è®°ä¸ºå·²è¯»",
  "data": {
    "readCount": 3,
    "readAt": "2025-11-09T15:33:00Z"
  }
}
```

---

## 7. è·å–æœªè¯»æ¶ˆæ¯æ•°

### æ¥å£ä¿¡æ¯
- **URL**: `/unread/count`
- **Method**: `GET`
- **åŠŸèƒ½**: è·å–æœªè¯»æ¶ˆæ¯æ€»æ•°å’Œä¼šè¯åˆ—è¡¨
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```
GET /api/v1/messages/unread/count
```

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalUnread": 15,
    "conversations": [
      {
        "userId": 10002,
        "unreadCount": 5,
        "lastMessage": {
          "messageId": "msg_789014",
          "content": "ä½ å¥½",
          "timestamp": "2025-11-09T15:30:00Z"
        }
      },
      {
        "groupId": "group_001",
        "unreadCount": 10,
        "lastMessage": {
          "messageId": "msg_789015",
          "content": "å¤§å®¶å¥½",
          "timestamp": "2025-11-09T15:31:00Z"
        }
      }
    ]
  }
}
```

---

## 8. è½¬å‘æ¶ˆæ¯

### æ¥å£ä¿¡æ¯
- **URL**: `/forward`
- **Method**: `POST`
- **åŠŸèƒ½**: è½¬å‘æ¶ˆæ¯åˆ°å…¶ä»–ç”¨æˆ·æˆ–ç¾¤ç»„
- **è®¤è¯**: éœ€è¦ Bearer Token

### Request
```json
{
  "messageId": "msg_789014",
  "targetUserIds": [10003, 10004],
  "targetGroupIds": ["group_002"]
}
```

### Response - æˆåŠŸ (200)
```json
{
  "code": 200,
  "message": "è½¬å‘æˆåŠŸ",
  "data": {
    "forwardedCount": 3,
    "newMessageIds": ["msg_789020", "msg_789021", "msg_789022"]
  }
}
```

---

## å½“å‰å®ç°çš„ REST æ¶ˆæ¯æ¥å£ï¼ˆIM-message-serverï¼‰

> æœ¬å°èŠ‚æè¿°å½“å‰ä»£ç ä¸­å·²å®ç°çš„åŸºäº HTTP çš„æ¶ˆæ¯å‘é€ä¸å†å²æŸ¥è¯¢æ¥å£ï¼Œä¸»è¦ç”± `IM-message-server` æä¾›ï¼Œå¹¶é€šè¿‡ `IM-Gateway` å¯¹å¤–æš´éœ²ã€‚

### 0.1 æœåŠ¡ä¿¡æ¯ï¼ˆå½“å‰å®ç°ï¼‰

- **å¯¹å¤–è®¿é—®ç½‘å…³**: IM-Gateway  
- **ç½‘å…³ç«¯å£**: 9001  
- **æ¨èå‰ç¼€**: `http://localhost:9001/api/v1/...`  
- **å†…éƒ¨æœåŠ¡ç«¯å£**: IM-message-server `8002`

å½“å‰ REST æ¥å£ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š

1. å•èŠæ¶ˆæ¯å‘é€æ¥å£ï¼š`/api/v1/privateChat/...`
2. ç¾¤èŠæ¶ˆæ¯å‘é€æ¥å£ï¼š`/api/v1/groupChat/...`
3. é€šç”¨æ¶ˆæ¯æ¥å£ï¼š`/api/v1/chat/...`ï¼ˆå†å²æ¶ˆæ¯ã€çŠ¶æ€æ›´æ–°ç­‰ï¼‰

æ‰€æœ‰æ¥å£çš„æˆåŠŸå“åº”ç»“æ„ç»Ÿä¸€ä¸ºï¼š

```json
{
  "success": true,
  "message": "è¯´æ˜æ–‡æœ¬",
  "data": { ... }  // å…·ä½“æ•°æ®ï¼Œé€šå¸¸æ˜¯ ChatMessage æˆ–åˆ—è¡¨
}
```

### 0.2 ChatMessage æ•°æ®æ¨¡å‹ï¼ˆRESTï¼‰

å½“å‰ REST æ¥å£è¿”å›çš„æ¶ˆæ¯å¯¹è±¡ç»Ÿä¸€ä¸º `ChatMessage`ï¼Œå­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š

```typescript
interface ChatMessage {
  messageId: string;          // æœåŠ¡å™¨ç”Ÿæˆçš„æ¶ˆæ¯å”¯ä¸€IDï¼ˆUUIDï¼‰
  clientMsgId?: string;       // å®¢æˆ·ç«¯ç”Ÿæˆçš„æ¶ˆæ¯IDï¼Œç”¨äºå¹‚ç­‰ä¸é‡è¯•
  conversationId?: string;    // ä¼šè¯IDï¼šå•èŠ userA-userBï¼Œç¾¤èŠ GROUP:<groupId>
  seq?: number;               // ä¼šè¯å†…æ¶ˆæ¯åºå·ï¼ˆé¢„ç•™ï¼‰
  status: 'SENT' | 'DELIVERED' | 'READ'; // æ¶ˆæ¯çŠ¶æ€
  createdAt: number;          // æ¶ˆæ¯åˆ›å»ºæ—¶é—´ï¼Œæ¯«ç§’æ—¶é—´æˆ³

  senderId: string;           // å‘é€æ–¹ID
  receiverId?: string;        // æ¥æ”¶æ–¹IDï¼ˆå•èŠï¼‰
  groupId?: string;           // ç¾¤ç»„IDï¼ˆç¾¤èŠï¼‰

  channelType: 'PRIVATE' | 'GROUP'; // ä¿¡é“ç±»å‹
  contentType: 'TEXT' | 'IMAGE' | 'VIDEO' | 'FILE' | 'AUDIO' | 'SYSTEM';

  // å®é™…è½½ä½“å†…å®¹ï¼Œä¸åŒ contentType å¯¹åº”ä¸åŒç»“æ„
  payload: any;
}
```

æœåŠ¡ç«¯ä¼šåœ¨å¤„ç†æ¶ˆæ¯æ—¶è‡ªåŠ¨è¡¥å……ï¼š

- `messageId`ï¼šå¦‚æœå®¢æˆ·ç«¯æœªæä¾›ï¼Œåˆ™ç”Ÿæˆ UUID
- `conversationId`ï¼š
  - å•èŠï¼šæŒ‰ `userId` å­—å…¸åºæ‹¼æ¥ï¼Œå¦‚ï¼š`user1-user2`
  - ç¾¤èŠï¼š`GROUP:<groupId>`
- `status`ï¼šé»˜è®¤ `SENT`
- `createdAt`ï¼šé»˜è®¤å½“å‰æ—¶é—´æˆ³

### 0.3 å•èŠ REST æ¥å£ç¤ºä¾‹

#### 0.3.1 å‘é€å•èŠæ–‡æœ¬æ¶ˆæ¯

- **URL**: `/api/v1/privateChat/send-text`  
- **Method**: `POST`  
- **è®¤è¯**: éœ€è¦é€šè¿‡ç½‘å…³çš„ JWT é‰´æƒ  
- **åŠŸèƒ½**: å‘é€ä¸€å¯¹ä¸€æ–‡æœ¬æ¶ˆæ¯

**è¯·æ±‚å‚æ•°ï¼ˆquery æˆ– formï¼‰**

| å‚æ•°       | ç±»å‹   | å¿…å¡« | è¯´æ˜           |
|------------|--------|------|----------------|
| senderId   | string | æ˜¯   | å‘é€æ–¹ç”¨æˆ·ID   |
| receiverId | string | æ˜¯   | æ¥æ”¶æ–¹ç”¨æˆ·ID   |
| text       | string | æ˜¯   | æ–‡æœ¬å†…å®¹       |

**å“åº”ç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰**

```json
{
  "success": true,
  "message": "æ–‡æœ¬æ¶ˆæ¯å‘é€æˆåŠŸ",
  "data": {
    "messageId": "8f92c3b0-...",
    "clientMsgId": null,
    "conversationId": "user1-user2",
    "status": "SENT",
    "createdAt": 1731800000000,
    "senderId": "user1",
    "receiverId": "user2",
    "channelType": "PRIVATE",
    "contentType": "TEXT",
    "payload": {
      "text": "ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ"
    }
  }
}
```

#### 0.3.2 å‘é€å•èŠå›¾ç‰‡/æ–‡ä»¶/è§†é¢‘/éŸ³é¢‘

å¯¹åº”çš„ URL å¦‚ä¸‹ï¼ˆå‡ä¸º `POST`ï¼‰ï¼š

- å›¾ç‰‡ï¼š`/api/v1/privateChat/send-image`
- æ–‡ä»¶ï¼š`/api/v1/privateChat/send-file`
- è§†é¢‘ï¼š`/api/v1/privateChat/send-video`
- éŸ³é¢‘ï¼š`/api/v1/privateChat/send-audio`

å‚æ•°å½¢å¼ä¸ä»£ç ä¸€è‡´ï¼Œä¸€èˆ¬ä¸ºï¼š`senderId`ã€`receiverId` ä»¥åŠå…·ä½“èµ„æºçš„ `url/filename/sizeInBytes/...`ï¼Œè¿”å› `data` å­—æ®µåŒæ ·ä¸º `ChatMessage`ï¼Œå…¶ä¸­ `contentType` åˆ†åˆ«ä¸º `IMAGE`ã€`FILE`ã€`VIDEO`ã€`AUDIO`ã€‚

### 0.4 ç¾¤èŠ REST æ¥å£ç¤ºä¾‹

#### 0.4.1 å‘é€ç¾¤èŠæ–‡æœ¬æ¶ˆæ¯

- **URL**: `/api/v1/groupChat/send-group-text`  
- **Method**: `POST`  
- **åŠŸèƒ½**: åœ¨æŒ‡å®šç¾¤ç»„ä¸­å‘é€æ–‡æœ¬æ¶ˆæ¯

**è¯·æ±‚å‚æ•°**

| å‚æ•°     | ç±»å‹   | å¿…å¡« | è¯´æ˜       |
|----------|--------|------|------------|
| senderId | string | æ˜¯   | å‘é€æ–¹ID   |
| groupId  | string | æ˜¯   | ç¾¤ç»„ID     |
| text     | string | æ˜¯   | æ–‡æœ¬å†…å®¹   |

**å“åº”ç»“æ„** åŒæ ·ä¸º `{ success, message, data: ChatMessage }`ï¼Œå…¶ä¸­ï¼š

- `channelType = "GROUP"`
- `groupId` ä¸ºç¾¤ID
- `conversationId = "GROUP:<groupId>"`

#### 0.4.2 å…¶ä»–ç¾¤èŠå¤šåª’ä½“æ¥å£

- å›¾ç‰‡ï¼š`/api/v1/groupChat/send-group-image`
- æ–‡ä»¶ï¼š`/api/v1/groupChat/send-group-file`
- è§†é¢‘ï¼š`/api/v1/groupChat/send-group-video`
- éŸ³é¢‘ï¼š`/api/v1/groupChat/send-group-audio`
- ç³»ç»Ÿé€šçŸ¥ï¼š`/api/v1/groupChat/send-group-system`

è¯·æ±‚å‚æ•°ä¸è¿”å›ç»“æ„ä¸å•èŠç±»ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨ `groupId` ä½œä¸ºä¼šè¯ç»´åº¦ã€‚

### 0.5 å†å²æ¶ˆæ¯æŸ¥è¯¢ï¼ˆRESTï¼‰

- **URL**: `/api/v1/chat/history`  
- **Method**: `GET`  
- **åŠŸèƒ½**: æŒ‰ä¼šè¯æŸ¥è¯¢å†å²æ¶ˆæ¯ï¼Œæ”¯æŒåŸºäº `createdAt` çš„æ¸¸æ ‡åˆ†é¡µ

**è¯·æ±‚å‚æ•°**

| å‚æ•°           | ç±»å‹   | å¿…å¡« | è¯´æ˜                                       |
|----------------|--------|------|--------------------------------------------|
| conversationId | string | æ˜¯   | ä¼šè¯IDï¼šå•èŠ `userA-userB`ï¼Œç¾¤èŠ `GROUP:xxx` |
| cursor         | long   | å¦   | ä¸Šä¸€é¡µæœ€åä¸€æ¡æ¶ˆæ¯çš„ `createdAt`ï¼Œç”¨äºç¿»é¡µ |
| size           | int    | å¦   | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 50                         |

**å“åº”ç¤ºä¾‹**

```json
{
  "success": true,
  "message": "è·å–å†å²æ¶ˆæ¯æˆåŠŸ",
  "data": [
    {
      "messageId": "8f92c3b0-...",
      "conversationId": "user1-user2",
      "status": "READ",
      "createdAt": 1731799000000,
      "senderId": "user1",
      "receiverId": "user2",
      "channelType": "PRIVATE",
      "contentType": "TEXT",
      "payload": { "text": "ä½ å¥½" }
    }
  ],
  "nextCursor": 1731799000000
}
```

- `data` ä¸ºæŒ‰æ—¶é—´å€’åºæŸ¥è¯¢çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆæœåŠ¡ç«¯å†…éƒ¨ä¸º `createdAt desc`ï¼‰ï¼Œå‰ç«¯å¯ä»¥æŒ‰éœ€è¦å†æ’åºå±•ç¤ºã€‚
- `nextCursor` ä¸ºä¸‹ä¸€æ¬¡ç¿»é¡µè¯·æ±‚çš„ `cursor`ï¼Œä¸ºç©ºè¡¨ç¤ºæ²¡æœ‰æ›´å¤šã€‚

### 0.6 æ¶ˆæ¯çŠ¶æ€æ›´æ–°ï¼ˆå·²é€è¾¾ / å·²è¯»ï¼‰

å½“å‰ç‰ˆæœ¬æä¾›ä¸¤ä¸ªç®€å•çš„æ¶ˆæ¯çŠ¶æ€æ›´æ–°æ¥å£ï¼Œç”¨äºé©±åŠ¨ `status = DELIVERED / READ`ï¼š

#### 0.6.1 æ ‡è®°æ¶ˆæ¯å·²é€è¾¾

- **URL**: `/api/v1/chat/ack-delivered`  
- **Method**: `POST`  
- **åŠŸèƒ½**: å°†æŒ‡å®šæ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸º `DELIVERED`

**è¯·æ±‚å‚æ•°**

| å‚æ•°      | ç±»å‹   | å¿…å¡« | è¯´æ˜       |
|-----------|--------|------|------------|
| messageId | string | æ˜¯   | æ¶ˆæ¯å”¯ä¸€ID |

**å“åº”ç¤ºä¾‹**

```json
{
  "success": true,
  "message": "æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º DELIVERED æˆåŠŸ",
  "data": {
    "messageId": "8f92c3b0-...",
    "status": "DELIVERED",
    "createdAt": 1731799000000,
    "senderId": "user1",
    "receiverId": "user2"
  }
}
```

#### 0.6.2 æ ‡è®°æ¶ˆæ¯å·²è¯»

- **URL**: `/api/v1/chat/ack-read`  
- **Method**: `POST`  
- **åŠŸèƒ½**: å°†æŒ‡å®šæ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸º `READ`

è¯·æ±‚å‚æ•°ä¸å“åº”ç»“æ„ä¸ `ack-delivered` ç±»ä¼¼ï¼Œåªæ˜¯æœ€ç»ˆçŠ¶æ€ä¸º `READ`ã€‚

> è¯´æ˜ï¼šæœ¬èŠ‚æ¥å£æ˜¯å½“å‰ä»£ç ä¸­å·²ç»å®ç°ã€å¯ç›´æ¥åœ¨ Web ç«¯è°ƒç”¨çš„ REST èƒ½åŠ›ï¼›å‰æ–‡ä¸­å…³äºâ€œæ’¤å›ã€è½¬å‘ã€æœªè¯»ç»Ÿè®¡â€ç­‰æ¥å£ä»ä¸ºè®¾è®¡è“å›¾ï¼Œåç»­å®ç°æ—¶å¯ä»¥å‚è€ƒæœ¬èŠ‚çš„ `ChatMessage` æ¨¡å‹ä¸çŠ¶æ€æµè½¬è®¾è®¡ã€‚

---

## æ¶ˆæ¯ç±»å‹

| ç±»å‹ | è¯´æ˜ | Contentæ ¼å¼ |
|------|------|-------------|
| TEXT | æ–‡æœ¬æ¶ˆæ¯ | string |
| IMAGE | å›¾ç‰‡æ¶ˆæ¯ | {url, thumbnail, width, height, size} |
| VIDEO | è§†é¢‘æ¶ˆæ¯ | {url, thumbnail, duration, size} |
| AUDIO | è¯­éŸ³æ¶ˆæ¯ | {url, duration, size} |
| FILE | æ–‡ä»¶æ¶ˆæ¯ | {url, filename, size, format} |
| LOCATION | ä½ç½®æ¶ˆæ¯ | {latitude, longitude, address} |
| CARD | åç‰‡æ¶ˆæ¯ | {userId, username, avatar} |
| SYSTEM | ç³»ç»Ÿæ¶ˆæ¯ | string |

---

## æ¶ˆæ¯çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| SENDING | å‘é€ä¸­ |
| SENT | å·²å‘é€ |
| DELIVERED | å·²é€è¾¾ |
| READ | å·²è¯» |
| FAILED | å‘é€å¤±è´¥ |
| RECALLED | å·²æ’¤å› |

---

## æ•°æ®æ¨¡å‹

### Message
```typescript
interface Message {
  messageId: string;          // æ¶ˆæ¯ID
  senderId: number;           // å‘é€è€…ID
  receiverId?: number;        // æ¥æ”¶è€…IDï¼ˆå•èŠï¼‰
  groupId?: string;           // ç¾¤ç»„IDï¼ˆç¾¤èŠï¼‰
  messageType: MessageType;   // æ¶ˆæ¯ç±»å‹
  content: string | object;   // æ¶ˆæ¯å†…å®¹
  status: MessageStatus;      // æ¶ˆæ¯çŠ¶æ€
  timestamp: string;          // å‘é€æ—¶é—´
  clientMsgId: string;        // å®¢æˆ·ç«¯æ¶ˆæ¯ID
  atUserIds?: number[];       // @çš„ç”¨æˆ·IDåˆ—è¡¨
  replyTo?: string;           // å›å¤çš„æ¶ˆæ¯ID
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-11-09  
**ç»´æŠ¤äºº**: å¼€å‘å›¢é˜Ÿ

# å¾®æœåŠ¡å¼€å‘æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [æœåŠ¡åˆ—è¡¨](#æœåŠ¡åˆ—è¡¨)
4. [å¼€å‘è§„èŒƒ](#å¼€å‘è§„èŒƒ)
5. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
6. [ç›‘æ§è¿ç»´](#ç›‘æ§è¿ç»´)

---

## æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯å±‚                            â”‚
â”‚  Webæµè§ˆå™¨  â”‚  iOS App  â”‚  Android App  â”‚  PCå®¢æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APIç½‘å…³å±‚                              â”‚
â”‚              Nginx / Kong / IMGateway                    â”‚
â”‚  - è·¯ç”±è½¬å‘  - è®¤è¯é‰´æƒ  - é™æµç†”æ–­  - è´Ÿè½½å‡è¡¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡  â”‚  â”‚ æ¶ˆæ¯æœåŠ¡  â”‚  â”‚ ç¾¤ç»„æœåŠ¡  â”‚
â”‚  :8001   â”‚  â”‚  :8002   â”‚  â”‚  :8003   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚
        â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åŸºç¡€è®¾æ–½å±‚                    â”‚
â”‚  Nacos  â”‚  Redis  â”‚  MySQL  â”‚  Kafka   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡é—´é€šä¿¡

- **åŒæ­¥è°ƒç”¨**: OpenFeign (HTTP/REST)
- **å¼‚æ­¥æ¶ˆæ¯**: Kafka / RabbitMQ
- **å®æ—¶é€šä¿¡**: WebSocket / STOMP
- **æœåŠ¡å‘ç°**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config

---

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Spring Boot | 3.5.7 | å¾®æœåŠ¡æ¡†æ¶ |
| Spring Cloud Gateway | 4.3.0 | APIç½‘å…³ |
| Spring Cloud Alibaba | 2023.0.3.2 | å¾®æœåŠ¡ç”Ÿæ€ |
| Nacos | 2.4.2 | æœåŠ¡æ³¨å†Œ/é…ç½®ä¸­å¿ƒ |
| Redis | 7.0+ | ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ— |
| MySQL | 8.0+ | å…³ç³»å‹æ•°æ®åº“ |
| MongoDB | 6.0+ | æ–‡æ¡£æ•°æ®åº“ |
| Kafka | 3.0+ | æ¶ˆæ¯é˜Ÿåˆ— |
| Elasticsearch | 8.0+ | æœç´¢å¼•æ“ |

### å‰ç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Vue | 3.4.0 | å‰ç«¯æ¡†æ¶ |
| Vite | 5.0.0 | æ„å»ºå·¥å…· |
| SockJS | 1.6.1 | WebSocketå®¢æˆ·ç«¯ |
| STOMP | 7.0.0 | æ¶ˆæ¯åè®® |

---

## æœåŠ¡åˆ—è¡¨

### 1. ç”¨æˆ·æœåŠ¡ (user-service)

**ç«¯å£**: 8001  
**èŒè´£**: ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†ã€å¥½å‹å…³ç³»

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/users/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/v1/users/login` - ç”¨æˆ·ç™»å½•
- `GET /api/v1/users/{userId}` - è·å–ç”¨æˆ·ä¿¡æ¯
- `GET /api/v1/users/friends` - è·å–å¥½å‹åˆ—è¡¨

**æ•°æ®åº“**: MySQL  
**ç¼“å­˜**: Redis (ç”¨æˆ·ä¿¡æ¯ã€Token)

---

### 2. æ¶ˆæ¯æœåŠ¡ (message-service)

**ç«¯å£**: 8002  
**èŒè´£**: æ¶ˆæ¯æ”¶å‘ã€å†å²è®°å½•ã€å·²è¯»æœªè¯»

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/messages/private` - å‘é€å•èŠæ¶ˆæ¯
- `POST /api/v1/messages/group` - å‘é€ç¾¤èŠæ¶ˆæ¯
- `GET /api/v1/messages/history` - è·å–å†å²æ¶ˆæ¯
- `POST /api/v1/messages/read` - æ ‡è®°å·²è¯»

**æ•°æ®åº“**: MongoDB (æ¶ˆæ¯å­˜å‚¨)  
**ç¼“å­˜**: Redis (æœªè¯»è®¡æ•°)  
**æ¶ˆæ¯é˜Ÿåˆ—**: Kafka (æ¶ˆæ¯åˆ†å‘)

---

### 3. ç¾¤ç»„æœåŠ¡ (group-service)

**ç«¯å£**: 8003  
**èŒè´£**: ç¾¤ç»„ç®¡ç†ã€æˆå‘˜ç®¡ç†ã€æƒé™æ§åˆ¶

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/groups` - åˆ›å»ºç¾¤ç»„
- `POST /api/v1/groups/{groupId}/members` - æ·»åŠ æˆå‘˜
- `GET /api/v1/groups/{groupId}` - è·å–ç¾¤ç»„ä¿¡æ¯
- `PUT /api/v1/groups/{groupId}/settings` - ç¾¤ç»„è®¾ç½®

**æ•°æ®åº“**: MySQL  
**ç¼“å­˜**: Redis (ç¾¤ç»„ä¿¡æ¯ã€æˆå‘˜åˆ—è¡¨)

---

### 4. åœ¨çº¿çŠ¶æ€æœåŠ¡ (presence-service)

**ç«¯å£**: 8004  
**èŒè´£**: ç”¨æˆ·åœ¨çº¿çŠ¶æ€ã€å¿ƒè·³æ£€æµ‹ã€å¤šç«¯ç™»å½•

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/presence/online` - ä¸Šçº¿
- `POST /api/v1/presence/offline` - ä¸‹çº¿
- `GET /api/v1/presence/status/{userId}` - æŸ¥è¯¢çŠ¶æ€
- `POST /api/v1/presence/heartbeat` - å¿ƒè·³

**æ•°æ®åº“**: Redis (çŠ¶æ€å­˜å‚¨)  
**å®æ—¶é€šä¿¡**: WebSocket

---

### 5. æ–‡ä»¶æœåŠ¡ (file-service)

**ç«¯å£**: 8005  
**èŒè´£**: æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€å›¾ç‰‡å¤„ç†

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/files/upload` - ä¸Šä¼ æ–‡ä»¶
- `GET /api/v1/files/{fileId}` - ä¸‹è½½æ–‡ä»¶
- `POST /api/v1/files/image/compress` - å›¾ç‰‡å‹ç¼©

**å­˜å‚¨**: OSS / MinIO  
**æ•°æ®åº“**: MySQL (æ–‡ä»¶å…ƒæ•°æ®)

---

### 6. æ¨é€æœåŠ¡ (push-service)

**ç«¯å£**: 8006  
**èŒè´£**: ç¦»çº¿æ¶ˆæ¯æ¨é€ã€ç³»ç»Ÿé€šçŸ¥

**æ ¸å¿ƒæ¥å£**:
- `POST /api/v1/push/send` - å‘é€æ¨é€
- `GET /api/v1/push/history` - æ¨é€å†å²

**æ¨é€æ¸ é“**: 
- iOS: APNs
- Android: FCM / æå…‰æ¨é€
- Web: WebSocket / Server-Sent Events

---

### 7. æœç´¢æœåŠ¡ (search-service)

**ç«¯å£**: 8007  
**èŒè´£**: å…¨æ–‡æœç´¢ã€æ¶ˆæ¯æ£€ç´¢

**æ ¸å¿ƒæ¥å£**:
- `GET /api/v1/search/messages` - æœç´¢æ¶ˆæ¯
- `GET /api/v1/search/users` - æœç´¢ç”¨æˆ·
- `GET /api/v1/search/groups` - æœç´¢ç¾¤ç»„

**æœç´¢å¼•æ“**: Elasticsearch

---

## å¼€å‘è§„èŒƒ

### 1. ä»£ç è§„èŒƒ

#### åŒ…ç»“æ„
```
com.example.service
â”œâ”€â”€ controller      # æ§åˆ¶å™¨å±‚
â”œâ”€â”€ service         # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ repository      # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ model           # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ entity      # å®ä½“ç±»
â”‚   â”œâ”€â”€ dto         # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ vo          # è§†å›¾å¯¹è±¡
â”œâ”€â”€ config          # é…ç½®ç±»
â”œâ”€â”€ exception       # å¼‚å¸¸å¤„ç†
â””â”€â”€ util            # å·¥å…·ç±»
```

#### å‘½åè§„èŒƒ

**Controller**:
```java
@RestController
@RequestMapping("/api/v1/users")
public class UserController {
    
    @PostMapping("/register")
    public Result<UserVO> register(@RequestBody @Valid RegisterRequest request) {
        // ...
    }
}
```

**Service**:
```java
@Service
public class UserService {
    
    public UserVO register(RegisterRequest request) {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

**Repository**:
```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
}
```

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

```java
@Data
public class Result<T> {
    private Integer code;      // çŠ¶æ€ç 
    private String message;    // æ¶ˆæ¯
    private T data;            // æ•°æ®
    private Long timestamp;    // æ—¶é—´æˆ³
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
    
    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}
```

### 3. å¼‚å¸¸å¤„ç†

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }
}
```

### 4. æ—¥å¿—è§„èŒƒ

```java
@Slf4j
@Service
public class UserService {
    
    public UserVO register(RegisterRequest request) {
        log.info("ç”¨æˆ·æ³¨å†Œå¼€å§‹, username={}", request.getUsername());
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            log.info("ç”¨æˆ·æ³¨å†ŒæˆåŠŸ, userId={}", user.getId());
            return userVO;
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ³¨å†Œå¤±è´¥, username={}", request.getUsername(), e);
            throw new BusinessException("æ³¨å†Œå¤±è´¥");
        }
    }
}
```

### 5. é…ç½®ç®¡ç†

**application.yml**:
```yaml
spring:
  application:
    name: user-service
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER:localhost:8848}
      config:
        server-addr: ${NACOS_SERVER:localhost:8848}
        file-extension: yaml
```

---

## éƒ¨ç½²æŒ‡å—

### 1. æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### å¯åŠ¨åŸºç¡€è®¾æ–½

```bash
# å¯åŠ¨Redis
redis-server

# å¯åŠ¨MySQL
mysql.server start

# å¯åŠ¨Nacos
sh startup.sh -m standalone
```

#### å¯åŠ¨å¾®æœåŠ¡

```bash
# ç”¨æˆ·æœåŠ¡
cd user-service
mvn spring-boot:run

# æ¶ˆæ¯æœåŠ¡
cd message-service
mvn spring-boot:run

# IMç½‘å…³
cd IMgateway
mvn spring-boot:run
```

### 2. Dockeréƒ¨ç½²

**docker-compose.yml**:
```yaml
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  mysql:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: root123
    ports:
      - "3306:3306"
  
  nacos:
    image: nacos/nacos-server:v2.4.2
    environment:
      MODE: standalone
    ports:
      - "8848:8848"
  
  user-service:
    build: ./user-service
    ports:
      - "8001:8001"
    depends_on:
      - redis
      - mysql
      - nacos
```

**å¯åŠ¨**:
```bash
docker-compose up -d
```

### 3. Kuberneteséƒ¨ç½²

**deployment.yaml**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: user-service:1.0.0
        ports:
        - containerPort: 8001
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
```

---

## ç›‘æ§è¿ç»´

### 1. å¥åº·æ£€æŸ¥

æ‰€æœ‰æœåŠ¡éƒ½é›†æˆäº†Spring Boot Actuator:

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8001/actuator/health

# æœåŠ¡ä¿¡æ¯
curl http://localhost:8001/actuator/info

# æŒ‡æ ‡æ•°æ®
curl http://localhost:8001/actuator/metrics
```

### 2. æ—¥å¿—æ”¶é›†

ä½¿ç”¨ELK Stack:
- **Elasticsearch**: æ—¥å¿—å­˜å‚¨
- **Logstash**: æ—¥å¿—æ”¶é›†
- **Kibana**: æ—¥å¿—å¯è§†åŒ–

### 3. ç›‘æ§å‘Šè­¦

ä½¿ç”¨Prometheus + Grafana:

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'spring-boot'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8001', 'localhost:8002']
```

### 4. é“¾è·¯è¿½è¸ª

ä½¿ç”¨Spring Cloud Sleuth + Zipkin:

```yaml
spring:
  sleuth:
    sampler:
      probability: 1.0
  zipkin:
    base-url: http://localhost:9411
```

---

## å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. ç«¯å£æ˜¯å¦è¢«å ç”¨
2. Nacosæ˜¯å¦å¯åŠ¨
3. Redis/MySQLæ˜¯å¦å¯è¿æ¥
4. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®

### Q2: æœåŠ¡é—´è°ƒç”¨å¤±è´¥ï¼Ÿ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°Nacos
2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
3. æŸ¥çœ‹æ—¥å¿—é”™è¯¯ä¿¡æ¯
4. éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ

### Q3: æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› **:
1. WebSocketè¿æ¥æ–­å¼€
2. Redisè¿æ¥å¤±è´¥
3. æ¥æ”¶è€…ä¸åœ¨çº¿
4. æ¶ˆæ¯æ ¼å¼é”™è¯¯

---

## å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/your-repo/im-system.git
cd im-system
```

### 2. å®‰è£…ä¾èµ–
```bash
mvn clean install
```

### 3. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose up -d redis mysql nacos

# å¯åŠ¨å¾®æœåŠ¡
./start-all.sh
```

### 4. è®¿é—®å‰ç«¯
```bash
cd frontend
npm install
npm run dev
```

è®¿é—®ï¼šhttp://localhost:3000

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-11-09  
**ç»´æŠ¤å›¢é˜Ÿ**: å¼€å‘å›¢é˜Ÿ

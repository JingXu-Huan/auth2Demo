# æ•°æ®åº“è®¾è®¡è§„èŒƒ (Database Design Standards)

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›®ä¿¡æ¯ | è¯¦æƒ… |
|---------|------|
| **é¡¹ç›®åç§°** | AIO ä¼ä¸šçº§å³æ—¶é€šè®¯ç³»ç»Ÿ |
| **æ–‡æ¡£ç±»å‹** | æ•°æ®åº“è®¾è®¡è§„èŒƒ |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-11-12 |
| **è®¾è®¡å¸ˆ** | æ•°æ®åº“è®¾è®¡å›¢é˜Ÿ |

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### æ ¸å¿ƒåŸåˆ™
1. **è§„èŒƒåŒ–è®¾è®¡**: éµå¾ªæ•°æ®åº“èŒƒå¼ï¼Œå‡å°‘æ•°æ®å†—ä½™
2. **æ€§èƒ½ä¼˜å…ˆ**: åˆç†çš„ç´¢å¼•è®¾è®¡å’ŒæŸ¥è¯¢ä¼˜åŒ–
3. **æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³å’Œå‚ç›´æ‰©å±•
4. **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
5. **å®‰å…¨æ€§**: æ•æ„Ÿæ•°æ®åŠ å¯†å’Œè®¿é—®æ§åˆ¶

### å‘½åè§„èŒƒ
- **è¡¨å**: å°å†™å­—æ¯ï¼Œå•è¯é—´ç”¨ä¸‹åˆ’çº¿åˆ†éš”ï¼Œä½¿ç”¨å¤æ•°å½¢å¼
- **å­—æ®µå**: å°å†™å­—æ¯ï¼Œå•è¯é—´ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- **ç´¢å¼•å**: `idx_è¡¨å_å­—æ®µå` æ ¼å¼
- **å¤–é”®å**: `fk_è¡¨å_å¼•ç”¨è¡¨å` æ ¼å¼

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„è®¾è®¡

### æ•°æ®åº“åˆ†ç¦»ç­–ç•¥

#### æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡æ•°æ®åº“åˆ†ç¦»                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ aio_user      â”‚ aio_message   â”‚ aio_group    â”‚ aio_file     â”‚
â”‚ (ç”¨æˆ·æ•°æ®)     â”‚ (æ¶ˆæ¯æ•°æ®)     â”‚ (ç¾¤ç»„æ•°æ®)    â”‚ (æ–‡ä»¶æ•°æ®)    â”‚
â”‚               â”‚               â”‚              â”‚              â”‚
â”‚ PostgreSQL    â”‚ MongoDB       â”‚ PostgreSQL   â”‚ PostgreSQL   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¯»å†™åˆ†ç¦»æ¶æ„
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åº”ç”¨æœåŠ¡       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚   å†™åº“(Master)  â”‚  â”‚  è¯»åº“(Slave) â”‚
            â”‚   PostgreSQL   â”‚  â”‚  PostgreSQL â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    æ•°æ®åŒæ­¥        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. ç”¨æˆ·ç›¸å…³è¡¨

#### users (ç”¨æˆ·è¡¨)
```sql
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(500),
    signature VARCHAR(200),
    gender VARCHAR(10) CHECK (gender IN ('MALE', 'FEMALE', 'UNKNOWN')),
    birthday DATE,
    location VARCHAR(100),
    status VARCHAR(20) DEFAULT 'OFFLINE' CHECK (status IN ('ONLINE', 'OFFLINE', 'BUSY', 'AWAY')),
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_active_status ON users(is_active, status);

-- è¡¨æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
COMMENT ON COLUMN users.user_id IS 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†';
COMMENT ON COLUMN users.password_hash IS 'BCryptåŠ å¯†åçš„å¯†ç ';
COMMENT ON COLUMN users.email_verified IS 'é‚®ç®±æ˜¯å¦å·²éªŒè¯';
```

#### user_profiles (ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨)
```sql
CREATE TABLE user_profiles (
    profile_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    company VARCHAR(100),
    department VARCHAR(100),
    position VARCHAR(100),
    work_phone VARCHAR(20),
    address TEXT,
    bio TEXT,
    social_links JSONB,
    preferences JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_user_profiles_company ON user_profiles(company);
CREATE INDEX idx_user_profiles_department ON user_profiles(department);
```

### 2. å¥½å‹å…³ç³»è¡¨

#### user_friends (å¥½å‹å…³ç³»è¡¨)
```sql
CREATE TABLE user_friends (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    friend_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    remark VARCHAR(50),
    source VARCHAR(20) CHECK (source IN ('SEARCH', 'QR_CODE', 'PHONE', 'GROUP', 'RECOMMENDATION')),
    status VARCHAR(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED', 'BLOCKED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id),
    CHECK (user_id != friend_id)
);

CREATE INDEX idx_user_friends_user_id ON user_friends(user_id);
CREATE INDEX idx_user_friends_friend_id ON user_friends(friend_id);
CREATE INDEX idx_user_friends_status ON user_friends(status);
CREATE INDEX idx_user_friends_user_status ON user_friends(user_id, status);
```

### 3. ç¾¤ç»„ç›¸å…³è¡¨

#### groups (ç¾¤ç»„è¡¨)
```sql
CREATE TABLE groups (
    group_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar VARCHAR(500),
    owner_id BIGINT NOT NULL REFERENCES users(user_id),
    member_count INT DEFAULT 0,
    max_members INT DEFAULT 500,
    join_type VARCHAR(20) DEFAULT 'FREE' CHECK (join_type IN ('FREE', 'APPROVAL', 'INVITE_ONLY')),
    is_public BOOLEAN DEFAULT FALSE,
    announcement TEXT,
    tags VARCHAR(50)[],
    settings JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_groups_owner_id ON groups(owner_id);
CREATE INDEX idx_groups_name ON groups(name);
CREATE INDEX idx_groups_is_public ON groups(is_public);
CREATE INDEX idx_groups_created_at ON groups(created_at);
CREATE INDEX idx_groups_member_count ON groups(member_count);
```

#### group_members (ç¾¤ç»„æˆå‘˜è¡¨)
```sql
CREATE TABLE group_members (
    id BIGSERIAL PRIMARY KEY,
    group_id VARCHAR(50) NOT NULL REFERENCES groups(group_id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'MEMBER' CHECK (role IN ('OWNER', 'ADMIN', 'MEMBER')),
    nickname VARCHAR(50),
    mute_until TIMESTAMP,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(group_id, user_id)
);

CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_user_id ON group_members(user_id);
CREATE INDEX idx_group_members_role ON group_members(role);
CREATE INDEX idx_group_members_joined_at ON group_members(joined_at);
```

### 4. æ¶ˆæ¯ç›¸å…³è¡¨ (MongoDB)

#### messages (æ¶ˆæ¯é›†åˆ)
```javascript
// æ¶ˆæ¯æ–‡æ¡£ç»“æ„
{
  "_id": ObjectId("..."),
  "messageId": "msg_1699612345678_001",
  "conversationId": "conv_user_10001_10002", // æˆ– "conv_group_group123"
  "conversationType": "PRIVATE", // PRIVATE, GROUP
  "senderId": 10001,
  "receiverId": 10002, // ç§èŠæ—¶ä½¿ç”¨
  "groupId": null, // ç¾¤èŠæ—¶ä½¿ç”¨
  "messageType": "TEXT", // TEXT, IMAGE, VIDEO, AUDIO, FILE, LOCATION, CARD
  "content": "Hello World",
  "contentExtra": { // æ‰©å±•å†…å®¹
    "fileName": "document.pdf",
    "fileSize": 1024000,
    "duration": 120, // éŸ³è§†é¢‘æ—¶é•¿
    "width": 1920, // å›¾ç‰‡å®½åº¦
    "height": 1080 // å›¾ç‰‡é«˜åº¦
  },
  "replyTo": null, // å›å¤çš„æ¶ˆæ¯ID
  "atUserIds": [], // @çš„ç”¨æˆ·IDåˆ—è¡¨
  "status": "SENT", // SENDING, SENT, DELIVERED, READ, FAILED, RECALLED
  "clientMsgId": "client_msg_123456",
  "deviceType": "WEB", // WEB, IOS, ANDROID, PC
  "ipAddress": "192.168.1.100",
  "createdAt": ISODate("2025-11-12T10:00:00Z"),
  "updatedAt": ISODate("2025-11-12T10:00:00Z"),
  "recalledAt": null,
  "recallReason": null
}

// ç´¢å¼•è®¾è®¡
db.messages.createIndex({
  "conversationId": 1,
  "createdAt": -1
});

db.messages.createIndex({
  "senderId": 1,
  "createdAt": -1
});

db.messages.createIndex({
  "messageType": 1,
  "createdAt": -1
});

db.messages.createIndex({
  "status": 1,
  "createdAt": -1
});

// å¤åˆç´¢å¼•
db.messages.createIndex({
  "conversationId": 1,
  "status": 1,
  "createdAt": -1
});
```

#### message_read_status (æ¶ˆæ¯å·²è¯»çŠ¶æ€)
```javascript
{
  "_id": ObjectId("..."),
  "messageId": "msg_1699612345678_001",
  "conversationId": "conv_group_group123",
  "userId": 10002,
  "readAt": ISODate("2025-11-12T10:05:00Z")
}

// ç´¢å¼•è®¾è®¡
db.message_read_status.createIndex({
  "messageId": 1,
  "userId": 1
}, { unique: true });

db.message_read_status.createIndex({
  "conversationId": 1,
  "userId": 1,
  "readAt": -1
});
```

### 5. æ–‡ä»¶ç›¸å…³è¡¨

#### files (æ–‡ä»¶è¡¨)
```sql
CREATE TABLE files (
    file_id VARCHAR(50) PRIMARY KEY,
    original_name VARCHAR(255) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    md5_hash VARCHAR(32) NOT NULL,
    uploader_id BIGINT NOT NULL REFERENCES users(user_id),
    upload_ip VARCHAR(50),
    storage_type VARCHAR(20) DEFAULT 'MINIO' CHECK (storage_type IN ('LOCAL', 'MINIO', 'OSS', 'S3')),
    bucket_name VARCHAR(100),
    is_public BOOLEAN DEFAULT FALSE,
    download_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_files_uploader_id ON files(uploader_id);
CREATE INDEX idx_files_file_type ON files(file_type);
CREATE INDEX idx_files_md5_hash ON files(md5_hash);
CREATE INDEX idx_files_created_at ON files(created_at);
CREATE INDEX idx_files_size_type ON files(file_size, file_type);
```

---

## ğŸ” ç´¢å¼•è®¾è®¡ç­–ç•¥

### ç´¢å¼•è®¾è®¡åŸåˆ™

#### 1. ä¸»é”®ç´¢å¼•
- æ‰€æœ‰è¡¨å¿…é¡»æœ‰ä¸»é”®
- ä¼˜å…ˆä½¿ç”¨è‡ªå¢IDæˆ–UUID
- è€ƒè™‘åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„IDç”Ÿæˆç­–ç•¥

#### 2. å”¯ä¸€ç´¢å¼•
```sql
-- ç”¨æˆ·åå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_username ON users(username);

-- é‚®ç®±å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- å¤åˆå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_user_friends_relation ON user_friends(user_id, friend_id);
```

#### 3. å¤åˆç´¢å¼•
```sql
-- æŸ¥è¯¢ä¼˜åŒ–å¤åˆç´¢å¼•
CREATE INDEX idx_messages_conversation_status_time ON messages(conversation_id, status, created_at DESC);

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_users_status_info ON users(status, user_id, nickname, avatar);
```

#### 4. éƒ¨åˆ†ç´¢å¼•
```sql
-- åªç´¢å¼•æ´»è·ƒç”¨æˆ·
CREATE INDEX idx_users_active ON users(created_at) WHERE is_active = true;

-- åªç´¢å¼•æœªè¯»æ¶ˆæ¯
CREATE INDEX idx_messages_unread ON messages(receiver_id, created_at) WHERE status != 'READ';
```

### ç´¢å¼•ç›‘æ§å’Œä¼˜åŒ–

#### ç´¢å¼•ä½¿ç”¨æƒ…å†µæŸ¥è¯¢
```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0;
```

---

## ğŸ”„ æ•°æ®åˆ†ç‰‡ç­–ç•¥

### æ°´å¹³åˆ†ç‰‡

#### 1. æ¶ˆæ¯è¡¨åˆ†ç‰‡ (MongoDB)
```javascript
// æŒ‰æ—¶é—´åˆ†ç‰‡
sh.shardCollection("aio_message.messages", {
  "createdAt": 1
});

// æŒ‰ä¼šè¯IDåˆ†ç‰‡
sh.shardCollection("aio_message.messages", {
  "conversationId": "hashed"
});
```

#### 2. ç”¨æˆ·è¡¨åˆ†ç‰‡ (PostgreSQL)
```sql
-- æŒ‰ç”¨æˆ·IDèŒƒå›´åˆ†ç‰‡
CREATE TABLE users_shard_1 (
    CHECK (user_id >= 1 AND user_id < 1000000)
) INHERITS (users);

CREATE TABLE users_shard_2 (
    CHECK (user_id >= 1000000 AND user_id < 2000000)  
) INHERITS (users);
```

### å‚ç›´åˆ†ç‰‡

#### æŒ‰ä¸šåŠ¡åŠŸèƒ½åˆ†ç¦»
```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE users_basic (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL
);

-- ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨
CREATE TABLE users_profile (
    user_id BIGINT PRIMARY KEY REFERENCES users_basic(user_id),
    nickname VARCHAR(50),
    avatar VARCHAR(500),
    signature VARCHAR(200)
);
```

---

## ğŸ” æ•°æ®å®‰å…¨è®¾è®¡

### æ•æ„Ÿæ•°æ®åŠ å¯†

#### å­—æ®µçº§åŠ å¯†
```sql
-- åŠ å¯†å­˜å‚¨æ•æ„Ÿä¿¡æ¯
CREATE TABLE users_secure (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email_encrypted BYTEA NOT NULL, -- åŠ å¯†å­˜å‚¨
    phone_encrypted BYTEA, -- åŠ å¯†å­˜å‚¨
    password_hash VARCHAR(255) NOT NULL
);

-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_field(plain_text TEXT, key_text TEXT)
RETURNS BYTEA AS $$
BEGIN
    RETURN pgp_sym_encrypt(plain_text, key_text);
END;
$$ LANGUAGE plpgsql;
```

#### åº”ç”¨å±‚åŠ å¯†
```java
@Entity
public class User {
    @Column(name = "phone")
    @Convert(converter = EncryptionConverter.class)
    private String phone;
    
    @Column(name = "email")
    @Convert(converter = EncryptionConverter.class) 
    private String email;
}

@Converter
public class EncryptionConverter implements AttributeConverter<String, String> {
    
    @Override
    public String convertToDatabaseColumn(String attribute) {
        return encryptionService.encrypt(attribute);
    }
    
    @Override
    public String convertToEntityAttribute(String dbData) {
        return encryptionService.decrypt(dbData);
    }
}
```

### è®¿é—®æ§åˆ¶

#### æ•°æ®åº“ç”¨æˆ·æƒé™
```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER readonly_user WITH PASSWORD 'readonly_password';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER app_user WITH PASSWORD 'app_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–

#### 1. æ…¢æŸ¥è¯¢ç›‘æ§
```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
ALTER SYSTEM SET log_min_duration_statement = 1000; -- 1ç§’
ALTER SYSTEM SET log_statement = 'all';

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

#### 2. æ‰§è¡Œè®¡åˆ’åˆ†æ
```sql
-- åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS) 
SELECT m.*, u.nickname 
FROM messages m
JOIN users u ON m.sender_id = u.user_id
WHERE m.conversation_id = 'conv_123'
ORDER BY m.created_at DESC
LIMIT 20;
```

### è¿æ¥æ± ä¼˜åŒ–

#### HikariCPé…ç½®
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
```

---

## ğŸ”§ æ•°æ®åº“ç»´æŠ¤

### å®šæœŸç»´æŠ¤ä»»åŠ¡

#### 1. æ•°æ®æ¸…ç†
```sql
-- æ¸…ç†è¿‡æœŸæ•°æ®
DELETE FROM login_logs 
WHERE login_at < NOW() - INTERVAL '90 days';

-- æ¸…ç†å·²åˆ é™¤çš„æ¶ˆæ¯
DELETE FROM messages 
WHERE status = 'DELETED' 
AND updated_at < NOW() - INTERVAL '30 days';
```

#### 2. ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
```sql
-- æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;
ANALYZE messages;
ANALYZE groups;

-- é‡å»ºç´¢å¼•
REINDEX INDEX CONCURRENTLY idx_messages_conversation_time;
```

### å¤‡ä»½ç­–ç•¥

#### 1. å…¨é‡å¤‡ä»½
```bash
#!/bin/bash
# æ•°æ®åº“å…¨é‡å¤‡ä»½è„šæœ¬
pg_dump -h localhost -U postgres -d aio_user > backup_$(date +%Y%m%d).sql
```

#### 2. å¢é‡å¤‡ä»½
```bash
# å¼€å¯WALå½’æ¡£
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

---

## ğŸ“‹ è®¾è®¡æ£€æŸ¥æ¸…å•

### è¡¨è®¾è®¡æ£€æŸ¥
- [ ] è¡¨åç¬¦åˆå‘½åè§„èŒƒ
- [ ] æ¯ä¸ªè¡¨éƒ½æœ‰ä¸»é”®
- [ ] å¤–é”®å…³ç³»æ­£ç¡®è®¾ç½®
- [ ] å­—æ®µç±»å‹é€‰æ‹©åˆé€‚
- [ ] å¿…è¦çš„çº¦æŸæ¡ä»¶å·²æ·»åŠ 
- [ ] è¡¨å’Œå­—æ®µæ³¨é‡Šå®Œæ•´

### ç´¢å¼•è®¾è®¡æ£€æŸ¥  
- [ ] ä¸»é”®ç´¢å¼•å·²åˆ›å»º
- [ ] å¤–é”®å­—æ®µå·²å»ºç´¢å¼•
- [ ] æŸ¥è¯¢é¢‘ç¹çš„å­—æ®µå·²å»ºç´¢å¼•
- [ ] å¤åˆç´¢å¼•é¡ºåºåˆç†
- [ ] é¿å…è¿‡å¤šå†—ä½™ç´¢å¼•

### æ€§èƒ½æ£€æŸ¥
- [ ] æ…¢æŸ¥è¯¢å·²ä¼˜åŒ–
- [ ] æ‰§è¡Œè®¡åˆ’åˆç†
- [ ] ç´¢å¼•ä½¿ç”¨ç‡é«˜
- [ ] è¿æ¥æ± é…ç½®åˆé€‚
- [ ] åˆ†ç‰‡ç­–ç•¥æœ‰æ•ˆ

### å®‰å…¨æ£€æŸ¥
- [ ] æ•æ„Ÿæ•°æ®å·²åŠ å¯†
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] å¤‡ä»½ç­–ç•¥å®Œå–„
- [ ] è®¿é—®æ—¥å¿—å¼€å¯
- [ ] æ•°æ®è„±æ•è§„åˆ™åˆ¶å®š

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12  
**ç»´æŠ¤äºº**: æ•°æ®åº“è®¾è®¡å›¢é˜Ÿ

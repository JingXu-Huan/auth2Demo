# ç³»ç»Ÿè®¾è®¡è¯¦è§£ (System Design Deep Dive)

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›®ä¿¡æ¯ | è¯¦æƒ… |
|---------|------|
| **é¡¹ç›®åç§°** | AIO ä¼ä¸šçº§å³æ—¶é€šè®¯ç³»ç»Ÿ |
| **æ–‡æ¡£ç±»å‹** | ç³»ç»Ÿè®¾è®¡è¯¦è§£ |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-11-12 |
| **è®¾è®¡å¸ˆ** | ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ |

---

## ğŸ¯ ç³»ç»Ÿè®¾è®¡æ¦‚è¿°

### è®¾è®¡ç†å¿µ
æœ¬ç³»ç»Ÿé‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)æ€æƒ³ï¼ŒæŒ‰ç…§ä¸šåŠ¡é¢†åŸŸè¿›è¡Œå¾®æœåŠ¡æ‹†åˆ†ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ï¼ŒæœåŠ¡é—´é€šè¿‡æ ‡å‡†åŒ–çš„APIè¿›è¡Œé€šä¿¡ï¼Œå®ç°é«˜å†…èšã€ä½è€¦åˆçš„æ¶æ„è®¾è®¡ã€‚

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªå¾®æœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
2. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
3. **ä¾èµ–å€’ç½®åŸåˆ™**: ä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°
4. **æ¥å£éš”ç¦»åŸåˆ™**: ä½¿ç”¨ä¸“ç”¨æ¥å£ï¼Œé¿å…æ¥å£æ±¡æŸ“
5. **æœ€å°çŸ¥è¯†åŸåˆ™**: æœåŠ¡é—´è€¦åˆåº¦æœ€å°åŒ–

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ¥å…¥å±‚ (Access Layer)                 â”‚
â”‚  Webå®¢æˆ·ç«¯ â”‚ ç§»åŠ¨å®¢æˆ·ç«¯ â”‚ æ¡Œé¢å®¢æˆ·ç«¯ â”‚ ç¬¬ä¸‰æ–¹é›†æˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS/WSS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç½‘å…³å±‚ (Gateway Layer)                     â”‚
â”‚  è·¯ç”±è½¬å‘ â”‚ è´Ÿè½½å‡è¡¡ â”‚ è®¤è¯é‰´æƒ â”‚ é™æµç†”æ–­ â”‚ åè®®è½¬æ¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/RPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡æœåŠ¡å±‚ (Business Layer)                 â”‚
â”‚  ç”¨æˆ·æœåŠ¡ â”‚ æ¶ˆæ¯æœåŠ¡ â”‚ ç¾¤ç»„æœåŠ¡ â”‚ æ–‡ä»¶æœåŠ¡ â”‚ é€šçŸ¥æœåŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®è®¿é—®å±‚ (Data Layer)                     â”‚
â”‚  PostgreSQL â”‚ MongoDB â”‚ Redis â”‚ Elasticsearch â”‚ MinIO      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¾®æœåŠ¡æ¶æ„è®¾è®¡

#### æœåŠ¡æ‹†åˆ†ç­–ç•¥
åŸºäºDDDé¢†åŸŸæ¨¡å‹è¿›è¡ŒæœåŠ¡æ‹†åˆ†ï¼š

1. **ç”¨æˆ·åŸŸ (User Domain)**
   - ç”¨æˆ·æœåŠ¡: ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†
   - è®¤è¯æœåŠ¡: OAuth2è®¤è¯ã€JWTç®¡ç†

2. **é€šä¿¡åŸŸ (Communication Domain)**
   - æ¶ˆæ¯æœåŠ¡: æ¶ˆæ¯æ”¶å‘ã€å†å²è®°å½•
   - ç¾¤ç»„æœåŠ¡: ç¾¤ç»„ç®¡ç†ã€æˆå‘˜ç®¡ç†
   - é€šçŸ¥æœåŠ¡: æ¶ˆæ¯æ¨é€ã€ç³»ç»Ÿé€šçŸ¥

3. **æ–‡ä»¶åŸŸ (File Domain)**
   - æ–‡ä»¶æœåŠ¡: æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€é¢„è§ˆ
   - åª’ä½“æœåŠ¡: éŸ³è§†é¢‘å¤„ç†ã€é€šè¯ç®¡ç†

4. **æœç´¢åŸŸ (Search Domain)**
   - æœç´¢æœåŠ¡: å…¨æ–‡æœç´¢ã€ç´¢å¼•ç®¡ç†

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. APIç½‘å…³è®¾è®¡

#### åŠŸèƒ½èŒè´£
- **è·¯ç”±ç®¡ç†**: æ ¹æ®è¯·æ±‚è·¯å¾„è·¯ç”±åˆ°å¯¹åº”æœåŠ¡
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•
- **è®¤è¯é‰´æƒ**: ç»Ÿä¸€çš„èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶
- **é™æµç†”æ–­**: ä¿æŠ¤åç«¯æœåŠ¡ç¨³å®šæ€§
- **åè®®è½¬æ¢**: HTTP/WebSocketåè®®é€‚é…

#### æŠ€æœ¯å®ç°
```yaml
# Gatewayè·¯ç”±é…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
```

### 2. æœåŠ¡æ³¨å†Œä¸å‘ç°

#### è®¾è®¡æ–¹æ¡ˆ
ä½¿ç”¨Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå®ç°æœåŠ¡çš„è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°ã€‚

```java
// æœåŠ¡æ³¨å†Œé…ç½®
@SpringBootApplication
@EnableDiscoveryClient
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

#### å¥åº·æ£€æŸ¥æœºåˆ¶
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
```

### 3. é…ç½®ç®¡ç†è®¾è®¡

#### é…ç½®ä¸­å¿ƒæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘ç¯å¢ƒé…ç½®   â”‚    â”‚   æµ‹è¯•ç¯å¢ƒé…ç½®   â”‚    â”‚   ç”Ÿäº§ç¯å¢ƒé…ç½®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nacos Config  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å¾®æœåŠ¡å®ä¾‹     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ æ•°æ®æ¶æ„è®¾è®¡

### æ•°æ®å­˜å‚¨é€‰å‹

#### 1. PostgreSQL - å…³ç³»å‹æ•°æ®
**ä½¿ç”¨åœºæ™¯**: ç”¨æˆ·ä¿¡æ¯ã€ç¾¤ç»„ä¿¡æ¯ã€æƒé™æ•°æ®
**è®¾è®¡åŸåˆ™**:
- ä¸¥æ ¼çš„ACIDäº‹åŠ¡ä¿è¯
- è§„èŒƒåŒ–è®¾è®¡å‡å°‘æ•°æ®å†—ä½™
- åˆç†çš„ç´¢å¼•è®¾è®¡æå‡æŸ¥è¯¢æ€§èƒ½

```sql
-- ç”¨æˆ·è¡¨è®¾è®¡
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(500),
    status VARCHAR(20) DEFAULT 'OFFLINE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¤åˆç´¢å¼•è®¾è®¡
CREATE INDEX idx_users_status_created ON users(status, created_at);
```

#### 2. MongoDB - æ–‡æ¡£å‹æ•°æ®
**ä½¿ç”¨åœºæ™¯**: æ¶ˆæ¯è®°å½•ã€èŠå¤©å†å²
**è®¾è®¡åŸåˆ™**:
- æ–‡æ¡£ç»“æ„çµæ´»é€‚åº”æ¶ˆæ¯å¤šæ ·æ€§
- åˆ†ç‰‡è®¾è®¡æ”¯æŒæµ·é‡æ•°æ®
- æ—¶é—´åºåˆ—ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

```javascript
// æ¶ˆæ¯æ–‡æ¡£è®¾è®¡
{
  "_id": ObjectId("..."),
  "messageId": "msg_123456",
  "conversationId": "conv_789",
  "senderId": 10001,
  "receiverId": 10002,
  "messageType": "TEXT",
  "content": "Hello World",
  "timestamp": ISODate("2025-11-12T10:00:00Z"),
  "status": "DELIVERED",
  "metadata": {
    "clientMsgId": "client_msg_123",
    "deviceType": "WEB",
    "ipAddress": "192.168.1.100"
  }
}
```

#### 3. Redis - ç¼“å­˜å’Œä¼šè¯
**ä½¿ç”¨åœºæ™¯**: ç”¨æˆ·ä¼šè¯ã€çƒ­ç‚¹æ•°æ®ç¼“å­˜ã€è®¡æ•°å™¨
**è®¾è®¡åŸåˆ™**:
- åˆç†çš„è¿‡æœŸæ—¶é—´è®¾ç½®
- ç¼“å­˜ç©¿é€å’Œé›ªå´©é˜²æŠ¤
- æ•°æ®ä¸€è‡´æ€§ä¿è¯

```java
// ç¼“å­˜è®¾è®¡æ¨¡å¼
@Service
public class UserCacheService {
    
    @Cacheable(value = "users", key = "#userId", unless = "#result == null")
    public User getUserById(Long userId) {
        return userRepository.findById(userId).orElse(null);
    }
    
    @CacheEvict(value = "users", key = "#user.userId")
    public void updateUser(User user) {
        userRepository.save(user);
    }
}
```

### æ•°æ®åˆ†ç‰‡ç­–ç•¥

#### æ¶ˆæ¯æ•°æ®åˆ†ç‰‡
```javascript
// æŒ‰ä¼šè¯IDè¿›è¡Œåˆ†ç‰‡
function getShardKey(conversationId) {
    return conversationId.hashCode() % SHARD_COUNT;
}

// åˆ†ç‰‡è·¯ç”±é…ç½®
{
  "shards": [
    {
      "name": "shard0",
      "host": "mongodb-shard0:27017"
    },
    {
      "name": "shard1", 
      "host": "mongodb-shard1:27017"
    }
  ]
}
```

---

## ğŸ”„ æœåŠ¡é—´é€šä¿¡è®¾è®¡

### åŒæ­¥é€šä¿¡ - OpenFeign

#### æ¥å£è®¾è®¡è§„èŒƒ
```java
@FeignClient(name = "user-service", fallback = UserServiceFallback.class)
public interface UserServiceClient {
    
    @GetMapping("/api/v1/users/{userId}")
    Result<UserDTO> getUserInfo(@PathVariable("userId") Long userId);
    
    @PostMapping("/api/v1/users/batch")
    Result<List<UserDTO>> getBatchUsers(@RequestBody List<Long> userIds);
}

// é™çº§å¤„ç†
@Component
public class UserServiceFallback implements UserServiceClient {
    
    @Override
    public Result<UserDTO> getUserInfo(Long userId) {
        return Result.error("ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    }
}
```

### å¼‚æ­¥é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ—

#### æ¶ˆæ¯è®¾è®¡æ¨¡å¼
```java
// äº‹ä»¶å‘å¸ƒ
@Service
public class MessageEventPublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void publishMessageSent(MessageSentEvent event) {
        rabbitTemplate.convertAndSend(
            "message.exchange", 
            "message.sent", 
            event
        );
    }
}

// äº‹ä»¶æ¶ˆè´¹
@RabbitListener(queues = "message.notification.queue")
public void handleMessageSent(MessageSentEvent event) {
    // å‘é€æ¨é€é€šçŸ¥
    notificationService.sendPushNotification(event);
}
```

---

## ğŸ” å®‰å…¨æ¶æ„è®¾è®¡

### è®¤è¯æˆæƒä½“ç³»

#### OAuth2 + JWTè®¾è®¡
```java
// JWT Tokenç»“æ„è®¾è®¡
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user@example.com",
    "userId": 10001,
    "roles": ["USER"],
    "permissions": ["READ", "WRITE"],
    "exp": 1699612345,
    "iat": 1699608745
  }
}

// TokenéªŒè¯è¿‡æ»¤å™¨
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) {
        String token = extractToken(request);
        if (token != null && jwtTokenProvider.validateToken(token)) {
            Authentication auth = jwtTokenProvider.getAuthentication(token);
            SecurityContextHolder.getContext().setAuthentication(auth);
        }
        filterChain.doFilter(request, response);
    }
}
```

### æ•°æ®å®‰å…¨è®¾è®¡

#### æ•æ„Ÿæ•°æ®åŠ å¯†
```java
// å­—æ®µçº§åŠ å¯†
@Entity
public class User {
    @Column(name = "phone")
    @Encrypted
    private String phone;
    
    @Column(name = "email") 
    @Encrypted
    private String email;
}

// åŠ å¯†å·¥å…·ç±»
@Component
public class FieldEncryption {
    
    public String encrypt(String plainText) {
        return AES.encrypt(plainText, secretKey);
    }
    
    public String decrypt(String cipherText) {
        return AES.decrypt(cipherText, secretKey);
    }
}
```

---

## ğŸ“Š æ€§èƒ½è®¾è®¡

### ç¼“å­˜æ¶æ„è®¾è®¡

#### å¤šçº§ç¼“å­˜ç­–ç•¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨ç¼“å­˜     â”‚    â”‚   CDNç¼“å­˜       â”‚    â”‚   Nginxç¼“å­˜     â”‚
â”‚   (é™æ€èµ„æº)     â”‚    â”‚   (é™æ€èµ„æº)     â”‚    â”‚   (APIå“åº”)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åº”ç”¨ç¼“å­˜       â”‚
                    â”‚   (çƒ­ç‚¹æ•°æ®)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Redisç¼“å­˜     â”‚
                    â”‚   (åˆ†å¸ƒå¼ç¼“å­˜)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ•°æ®åº“        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
```java
// Cache-Asideæ¨¡å¼
@Service
public class UserService {
    
    public User getUserById(Long userId) {
        // 1. å…ˆæŸ¥ç¼“å­˜
        User user = cacheService.get("user:" + userId);
        if (user != null) {
            return user;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        user = userRepository.findById(userId);
        if (user != null) {
            // 3. å†™å…¥ç¼“å­˜
            cacheService.set("user:" + userId, user, Duration.ofMinutes(30));
        }
        
        return user;
    }
}
```

### æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
```sql
-- ç´¢å¼•ä¼˜åŒ–
EXPLAIN ANALYZE SELECT * FROM messages 
WHERE conversation_id = 'conv_123' 
ORDER BY created_at DESC 
LIMIT 20;

-- åˆ†åŒºè¡¨è®¾è®¡
CREATE TABLE messages_2025_11 PARTITION OF messages
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

-- è¯»å†™åˆ†ç¦»é…ç½®
spring:
  datasource:
    master:
      url: jdbc:postgresql://master-db:5432/aio
    slave:
      url: jdbc:postgresql://slave-db:5432/aio
```

---

## ğŸ”„ å¯é æ€§è®¾è®¡

### å®¹é”™æœºåˆ¶

#### ç†”æ–­å™¨è®¾è®¡
```java
@Component
public class UserServiceCircuitBreaker {
    
    @CircuitBreaker(name = "user-service", fallbackMethod = "fallbackGetUser")
    @TimeLimiter(name = "user-service")
    public CompletableFuture<User> getUserAsync(Long userId) {
        return CompletableFuture.supplyAsync(() -> 
            userServiceClient.getUserInfo(userId)
        );
    }
    
    public CompletableFuture<User> fallbackGetUser(Long userId, Exception ex) {
        return CompletableFuture.completedFuture(getDefaultUser());
    }
}
```

#### é‡è¯•æœºåˆ¶
```java
@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void sendMessage(Message message) {
    messageServiceClient.sendMessage(message);
}
```

### æ•°æ®ä¸€è‡´æ€§è®¾è®¡

#### åˆ†å¸ƒå¼äº‹åŠ¡
```java
// Seataåˆ†å¸ƒå¼äº‹åŠ¡
@GlobalTransactional
public void transferMessage(TransferRequest request) {
    // 1. åˆ›å»ºæ¶ˆæ¯
    messageService.createMessage(request.getMessage());
    
    // 2. æ›´æ–°ç”¨æˆ·çŠ¶æ€
    userService.updateLastActiveTime(request.getUserId());
    
    // 3. å‘é€é€šçŸ¥
    notificationService.sendNotification(request.getNotification());
}
```

---

## ğŸ“ˆ ç›‘æ§è®¾è®¡

### å¯è§‚æµ‹æ€§æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Metrics       â”‚    â”‚   Logging       â”‚    â”‚   Tracing       â”‚
â”‚   (Prometheus)  â”‚    â”‚   (ELK Stack)   â”‚    â”‚   (Zipkin)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Grafana       â”‚
                    â”‚   (å¯è§†åŒ–)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‡æ ‡ç›‘æ§
```java
// è‡ªå®šä¹‰æŒ‡æ ‡
@Component
public class MessageMetrics {
    
    private final Counter messageCounter = Counter.builder("messages.sent.total")
        .description("Total messages sent")
        .register(Metrics.globalRegistry);
    
    private final Timer messageTimer = Timer.builder("message.processing.time")
        .description("Message processing time")
        .register(Metrics.globalRegistry);
    
    public void recordMessageSent() {
        messageCounter.increment();
    }
    
    public void recordProcessingTime(Duration duration) {
        messageTimer.record(duration);
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12  
**ç»´æŠ¤äºº**: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ

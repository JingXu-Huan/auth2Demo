这是一个基于你之前的“多语言微服务 + 飞书模式 + 深度风控”蓝图的**全景式模块设计方案**。

为了达到“完整、健全”的标准，我将系统拆分为 **7 大领域、12 个核心微服务**，涵盖了从接入层到基础设施层的每一个细节。每个模块都详细定义了**职责边界、关键技术栈、核心逻辑和数据交互**。

---

### 一、 接入网关层 (Access & Gateway Layer)
_负责流量的入口、协议转换与安全屏障。_

#### 1. `gateway-service` (API 网关)
+ **技术栈**: Spring Cloud Gateway, Sentinel (限流)
+ **核心职责**:
    - **统一鉴权**: 校验 JWT Token 有效性（不仅验签，还需查 Redis 确认 Token 是否被强制注销）。
    - **全局风控拦截**: 基于 Redis 黑名单拦截被封禁 IP 或 UserID。
    - **动态路由**: 将 `/api/auth` 转发至认证服务，`/api/doc` 转发至 Node.js 服务。
    - **灰度发布**: 基于 Header 分流流量。

#### 2. `im-gateway` (IM 长连接网关)
+ **技术栈**: Netty (Java), Protobuf (协议)
+ **核心职责**:
    - **WebSocket 维护**: 管理数百万用户的长连接，维护 `UserID -> Channel` 的映射关系（Local Map）。
    - **连接鉴权**: 握手时校验 Token。
    - **消息下行 (Push)**: 接收 MQ 投递的消息，通过长连接推送到客户端。
    - **心跳检测**: 自动断开僵尸连接，更新 Redis 中的 `user_devices` 在线状态。
    - **协议解析**: 将二进制 Protobuf 解包为内部对象。

---

### 二、 核心业务层 (Core Business Layer)
_系统的控制平面，处理复杂的业务逻辑。_

#### 3. `auth-service` (统一身份与安全中心)
+ **技术栈**: Spring Boot, Spring Security, JustAuth (第三方登录)
+ **核心职责**:
    - **多因子登录**: 处理邮箱/密码、Gitee OAuth、验证码登录。
    - **Token 颁发**: 生成 Access Token (Stateless) + Refresh Token (Redis)。
    - **设备管理**: 记录 `user_devices`，实现“踢人下线”逻辑（发布 MQ 消息通知 `im-gateway` 断连）。
    - **风控引擎**: 记录 `user_punishments`，提供“用户是否被封禁”的 RPC 查询接口。

#### 4. `user-service` (组织架构服务)
+ **技术栈**: Spring Boot, MyBatis Plus
+ **核心职责**:
    - **组织管理**: 维护 `departments` 和 `users` 表，处理部门的增删改查。
    - **路径计算**: 维护 `path` 字段，提供高效的子部门检索。
    - **事件广播**: 当人员/部门变更时，发送 `ORG_CHANGE` 事件到 RocketMQ（供 Neo4j 同步）。
    - **通讯录查询**: 提供扁平化的通讯录列表。

#### 5. `im-service` (IM 业务逻辑服务)
+ **技术栈**: Spring Boot, RocketMQ Template
+ **核心职责**:
    - **消息发送 (Send)**:
        1. 申请全局唯一 SeqID (Redis Lua)。
        2. 执行写扩散/读扩散策略判断。
        3. 发送 RocketMQ 事务消息 (Half Message -> Local DB Transaction -> Commit)。
    - **消息拉取 (Sync)**: 处理 `/sync` 接口，查询 `chat_inbox` 或 `chat_messages` 分区表。
    - **会话管理**: 创建群组、踢人、设置管理员（操作 `channels` 和 `channel_members`）。
    - **消息互动**: 处理消息点赞、撤回逻辑。

---

### 三、 实时协同层 (Real-time Collaboration Layer)
_系统的“高速数据平面”，处理 CRDT 计算。_

#### 6. `collab-service` (文档协同 Sidecar)
+ **技术栈**: **Node.js**, Yjs, ws (WebSocket库), Redis
+ **核心职责**:
    - **房间管理**: 维护 `doc_id` 对应的协同房间。
    - **Yjs 同步**: 处理 `sync-step1`, `sync-step2` 协议，广播 `update` 二进制流。
    - **光标感知 (Awareness)**: 广播“谁正在看哪一行”的临时状态。
    - **写缓冲**: 将合并后的 `update` 数据推送到 Redis Stream，不直接写库。
    - **鉴权**: 握手时调用 `auth-service` 或解析 JWT 校验权限。

---

### 四、 数据持久化与同步层 (Data & Sync Layer)
_负责数据的最终一致性与异构存储同步。_

#### 7. `sync-worker` (异步同步服务)
+ **技术栈**: Java, RocketMQ Listener, Redis Stream Consumer
+ **核心职责**:
    - **文档落库**: 消费 Redis Stream 中的 Yjs Update，合并到 `documents` 表的 `snapshot_binary` 字段。
    - **Neo4j 同步**: 消费 RocketMQ 的 `USER_CREATED`, `DEPT_MOVED` 等事件，执行 Cypher 语句更新图数据库。
    - **ES 索引构建**: 消费 IM 消息和文档更新，写入 Elasticsearch 供全文检索。

#### 8. `file-service` (文件对象服务)
+ **技术栈**: Spring Boot, MinIO SDK
+ **核心职责**:
    - **CAS 预检**: 计算 Hash，查询 `file_metadata` 是否已存在（秒传）。
    - **签名分发**: 生成 MinIO 的 Presigned URL 供前端直传/下载。
    - **生命周期管理**: 扫描 `ref_count=0` 的文件，执行 MinIO 物理删除。
    - **图片处理**: 异步生成缩略图（利用 Thumbnailator）。

---

### 五、 智能与搜索层 (Intelligence Layer)
_基于 RAG 和全文检索的增值服务。_

#### 9. `search-service` (搜索与 AI 助手)
+ **技术栈**: Elasticsearch, LangChain4j (或 Python MCP Server)
+ **核心职责**:
    - **全文检索**: 提供对聊天记录、文档内容的混合搜索（高亮、分词）。
    - **权限过滤**: 搜索时带上 UserID，确保不搜到无权查看的文档（利用 ES 的 Security Filter）。
    - **RAG 检索**: 当用户 @AI 时，向量化查询相关文档片段，构建 Context。
    - **MCP 服务**: 封装“查询日程”、“查询报表”等工具供 LLM 调用。

---

### 六、 运维与监控层 (Infra & Ops)
_保障系统稳定运行。_

#### 10. `admin-service` (管理后台)
+ **职责**: 提供给公司 IT 管理员的 Web 界面。
+ **功能**: 查看审计日志 (`audit_logs`)、手动封禁用户、查看在线人数、配置系统参数（如文件保留天数）。

#### 11. `job-service` (定时任务)
+ **技术栈**: XXL-JOB
+ **职责**:
    - **分区管理**: 每月自动创建 Postgres 的下个月分区表。
    - **文件 GC**: 每日扫描并清理孤儿文件。
    - **报表统计**: 每日计算群活跃度、消息总量。

---

### 七、 模块间关键交互流程 (Cross-Module Flows)
#### 场景 1：发送一条群消息
1. **Frontend** -> **Gateway** -> **im-service**: 发送请求。
2. **im-service**:
    - 调用 **Redis**: 获取 SeqID。
    - 写入 **PostgreSQL**: `chat_messages` (Transaction Start)。
    - 发送 **RocketMQ**: Topic `IM_MSG_SEND` (Transaction Commit)。
3. **im-service** -> **im-gateway**: 若是小群，直接 RPC 调用网关推送 Notify。
4. **im-gateway** -> **Frontend**: WebSocket 推送新消息通知。
5. **sync-worker** -> **Elasticsearch**: 消费 MQ，索引该消息。
6. **sync-worker** -> **Push Service**: (可选) 消费 MQ，调用 APNs/FCM 推送离线通知。

#### 场景 2：新建文档并邀请成员
1. **Frontend** -> **Gateway** -> **collab-service**: 建立 WS 连接。
2. **collab-service**: 将内容写入 Redis Stream。
3. **sync-worker**: 消费 Stream，更新 Postgres `documents` 表。
4. **Frontend** -> **user-service**: 修改权限（添加协作者）。
5. **user-service**: 发送 MQ `PERM_CHANGE`。
6. **sync-worker**: 消费 MQ，更新 Neo4j 中的 `(:User)-[:CAN_EDIT]->(:Doc)` 关系。

---

### 八、 数据库与中间件部署清单
| 组件 | 用途 | 关键配置 |
| :--- | :--- | :--- |
| **PostgreSQL** | 核心存储 | 开启 Partitioning, 配置 pg_partman |
| **Neo4j** | 图关系 | 开启 Bolt 协议, 内存堆大小优化 |
| **Redis Cluster** | 缓存/Seq/Token | AOF 开启, Stream 数据结构支持 |
| **RocketMQ** | 消息总线 | 配置 TransactionTopic, OrderlyConsumer |
| **MinIO** | 对象存储 | 配置 Bucket Policy, 纠删码模式 |
| **Elasticsearch** | 全文检索 | IK 分词器, 索引生命周期管理 (ILM) |
| **Nacos/Eureka** | 注册中心 | 服务发现与配置管理 |


这个模块设计覆盖了从**用户准入、核心交互、数据一致性到运维治理**的方方面面，能够支撑一个功能完整、逻辑严密的企业级协作平台。

